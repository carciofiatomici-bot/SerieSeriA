<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#16a34a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Serie SeriA">
    <meta name="description" content="Gestisci la tua squadra di fantacalcio, partecipa al draft e sfida i tuoi amici!">
    <title>Serie SeriA</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icone PWA -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/serie%20sera%20256.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/serie%20sera%20256.png">

    <!-- Carica Tailwind CSS dal CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Collega il foglio di stile esterno -->
    <link rel="stylesheet" href="style.css">
    <!-- CARICA FONT AWESOME (per icone tipologie) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

    <!-- ALERT DRAFT ATTIVO - Flottante in alto a sinistra, sempre visibile quando c'√® un draft -->
    <div id="draft-alert-banner" class="hidden"
         style="position: fixed; top: 10px; left: 10px; z-index: 9999; max-width: 320px;">
        <!-- Versione espansa -->
        <div id="draft-alert-expanded" class="p-3 bg-gradient-to-r from-purple-900 to-indigo-900 rounded-lg border-2 border-purple-500 shadow-2xl">
            <div class="flex items-center gap-3">
                <span class="text-2xl">üéØ</span>
                <div class="flex-1">
                    <p class="text-purple-300 text-xs font-semibold">DRAFT IN CORSO</p>
                    <p class="text-white font-bold text-sm"><span id="draft-alert-team" class="text-yellow-400">--</span></p>
                    <p id="draft-alert-steal-info" class="hidden text-red-300 text-xs font-semibold"></p>
                </div>
                <div class="text-center">
                    <p class="text-purple-300 text-xs">Tempo</p>
                    <p id="draft-alert-countdown" class="text-xl font-bold text-white">--:--</p>
                </div>
                <!-- Bottone minimizza -->
                <button id="draft-alert-minimize"
                        onclick="window.InterfacciaDashboard?.toggleDraftAlertMinimized(true)"
                        class="text-purple-300 hover:text-white transition p-1 -mr-1 -mt-6"
                        title="Minimizza">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            <button id="draft-alert-go-btn"
                    class="w-full mt-2 bg-purple-600 hover:bg-purple-500 text-white font-bold py-1.5 px-3 rounded-lg transition text-xs">
                Vai al Draft ‚Üí
            </button>
        </div>
        <!-- Versione minimizzata (icona compatta) -->
        <div id="draft-alert-minimized" class="hidden">
            <button onclick="window.InterfacciaDashboard?.toggleDraftAlertMinimized(false)"
                    class="p-2 bg-gradient-to-r from-purple-900 to-indigo-900 rounded-lg border-2 border-purple-500 shadow-2xl flex items-center gap-2 hover:scale-105 transition"
                    title="Espandi alert Draft">
                <span class="text-xl">üéØ</span>
                <span id="draft-alert-countdown-mini" class="text-sm font-bold text-white">--:--</span>
            </button>
        </div>
    </div>

    <!-- Bottone Regole Globale (sempre visibile) - z-index alto per stare sopra tutto -->
    <button id="rules-global-btn"
            onclick="window.RulesPanel.toggle()"
            style="position: fixed; bottom: 20px; right: 20px; z-index: 9998;
                   background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                   color: white; font-weight: bold; padding: 12px 20px;
                   border-radius: 50px; border: none; cursor: pointer;
                   box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                   font-size: 16px; display: flex; align-items: center; gap: 8px;
                   transition: all 0.3s ease;">
        <span style="font-size: 20px;">üìñ</span> Regole
    </button>

    <!-- Pannello Regole (nascosto inizialmente) - z-index molto alto per stare sempre in primo piano -->
    <div id="rules-panel" class="hidden fixed inset-0 bg-black bg-opacity-95 z-[9999] overflow-y-auto">
        <div class="container mx-auto px-4 py-8 max-w-4xl">
            <!-- Header -->
            <div class="bg-gradient-to-r from-purple-900 to-indigo-900 rounded-t-lg p-6 border-b-4 border-yellow-500">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-4xl font-bold text-white mb-2">üìñ Regole del Gioco</h1>
                        <p class="text-gray-300">Serie SeriA - Fantacalcio Serio</p>
                    </div>
                    <button onclick="window.RulesPanel.close()"
                            class="text-white hover:text-red-400 text-4xl font-bold">
                        X
                    </button>
                </div>
            </div>

            <!-- Contenuto Regole -->
            <div class="bg-gray-800 p-6 space-y-6">

                <!-- Sezione Squadra -->
                <div class="bg-gray-900 rounded-lg p-4 border border-gray-700">
                    <h3 class="text-xl font-bold text-yellow-400 mb-3">‚öΩ La Squadra</h3>
                    <ul class="text-gray-300 space-y-2 text-sm">
                        <li>‚Ä¢ Ogni squadra ha <strong class="text-white">12 giocatori + 1 Icona</strong> (capitano speciale)</li>
                        <li>‚Ä¢ Ruoli: <span class="text-blue-400">P</span> (Portiere), <span class="text-green-400">D</span> (Difensore), <span class="text-yellow-400">C</span> (Centrocampista), <span class="text-red-400">A</span> (Attaccante)</li>
                        <li>‚Ä¢ Tipologie: <span class="text-red-400">Potenza</span> > <span class="text-blue-400">Tecnica</span> > <span class="text-yellow-400">Velocita</span> > <span class="text-red-400">Potenza</span> (carta-forbice-sasso)</li>
                        <li>‚Ä¢ Ogni giocatore ha un livello (1-20) che influenza le statistiche</li>
                    </ul>
                </div>

                <!-- Sezione Partita -->
                <div class="bg-gray-900 rounded-lg p-4 border border-gray-700">
                    <h3 class="text-xl font-bold text-green-400 mb-3">üéÆ La Partita</h3>
                    <ul class="text-gray-300 space-y-2 text-sm">
                        <li>‚Ä¢ Ogni partita ha 3 fasi: <strong class="text-white">Costruzione</strong>, <strong class="text-white">Attacco</strong>, <strong class="text-white">Tiro</strong></li>
                        <li>‚Ä¢ Nella fase Costruzione si contende il possesso palla</li>
                        <li>‚Ä¢ Nella fase Attacco si cerca di superare la difesa</li>
                        <li>‚Ä¢ Nella fase Tiro si cerca di segnare contro il portiere</li>
                        <li>‚Ä¢ Le abilita si attivano in specifiche fasi</li>
                    </ul>
                </div>

                <!-- Sezione Valute -->
                <div class="bg-gray-900 rounded-lg p-4 border border-gray-700">
                    <h3 class="text-xl font-bold text-amber-400 mb-3">üí∞ Valute</h3>
                    <ul class="text-gray-300 space-y-2 text-sm">
                        <li>‚Ä¢ <strong class="text-white">CS (Crediti Seri)</strong>: Valuta standard per acquistare giocatori</li>
                        <li>‚Ä¢ <strong class="text-amber-400">CSS (Crediti Super Seri)</strong>: Valuta premium per potenziamenti e abilita</li>
                        <li>‚Ä¢ Si guadagnano CS vincendo partite e completando la stagione</li>
                        <li>‚Ä¢ Si guadagnano CSS vincendo trofei (Campionato, Coppa, Supercoppa)</li>
                    </ul>
                </div>

                <!-- Sezione Competizioni -->
                <div class="bg-gray-900 rounded-lg p-4 border border-gray-700">
                    <h3 class="text-xl font-bold text-purple-400 mb-3">üèÜ Competizioni</h3>
                    <ul class="text-gray-300 space-y-2 text-sm">
                        <li>‚Ä¢ <strong class="text-green-400">SerieSeriA</strong>: Campionato a girone unico, tutti contro tutti</li>
                        <li>‚Ä¢ <strong class="text-purple-400">CoppaSeriA</strong>: Eliminazione diretta con andata e ritorno</li>
                        <li>‚Ä¢ <strong class="text-yellow-400">Supercoppa</strong>: Partita secca tra Campione e Vincitore Coppa</li>
                    </ul>
                </div>

                <!-- Sezione Enciclopedia Abilita (Collassabile) -->
                <div class="bg-gray-900 rounded-lg border border-purple-500">
                    <button id="btn-toggle-encyclopedia"
                            onclick="window.RulesPanel.toggleEncyclopedia()"
                            class="w-full p-4 flex justify-between items-center text-left hover:bg-gray-800 rounded-lg transition">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">üìî</span>
                            <div>
                                <h3 class="text-xl font-bold text-purple-400">Enciclopedia Abilita</h3>
                                <p class="text-gray-400 text-sm">Clicca per espandere la lista completa delle abilita</p>
                            </div>
                        </div>
                        <span id="encyclopedia-arrow" class="text-purple-400 text-2xl transition-transform">‚ñº</span>
                    </button>
                    <div id="encyclopedia-content" class="hidden p-4 border-t border-purple-700">
                        <div id="encyclopedia-container">
                            <!-- Contenuto enciclopedia caricato dinamicamente -->
                            <p class="text-gray-400 text-center">Caricamento abilita...</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Footer -->
            <div class="bg-gray-900 p-4 rounded-b-lg">
                <button onclick="window.RulesPanel.close()"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-lg">
                    Chiudi Regole
                </button>
            </div>
        </div>
    </div>

    <main class="min-h-screen p-4 flex flex-col items-center justify-center">

        <!-- 1. BOX GATE (Richiesta Password "seria") -->
        <div id="gate-box" class="football-box w-full max-w-sm transition duration-500 hidden-on-load">
            <h2 class="text-2xl font-bold text-green-400 mb-6 text-center border-b-2 border-green-600 pb-2">Accesso Riservato - Il Campo Ti Aspetta</h2>
            <p class="text-gray-300 mb-4 text-sm text-center">Inserisci la password seria per sbloccare la panchina.</p>
            
            <input type="password" id="gate-password" placeholder="Password seria"
                   class="w-full p-3 border border-green-600 rounded-lg focus:ring-green-400 focus:border-green-400 bg-gray-700 text-white mb-4 shadow-inner-dark">
            
            <button id="gate-button"
                    class="w-full bg-green-500 text-gray-900 font-extrabold py-3 rounded-lg shadow-xl hover:bg-green-400 transition duration-150 transform hover:scale-[1.02]">
                Inizia il Riscaldamento Serio
            </button>
            
            <p id="gate-message" class="text-center mt-3 text-red-400"></p>
        </div>

        <!-- 2. BOX LOGIN (Nome Squadra / Password) -->
        <div id="login-box" class="football-box w-full max-w-sm transition duration-500 hidden-on-load">
            <h2 class="text-2xl font-bold text-yellow-400 mb-6 text-center border-b-2 border-yellow-600 pb-2">Accedi alla tua Dashboard</h2>

            <!-- SEZIONE SESSIONE RICORDATA (nascosta di default) -->
            <div id="remembered-session-box" class="hidden mb-4">
                <div class="p-4 bg-gray-700 rounded-lg border-2 border-green-500 text-center">
                    <img id="remembered-team-logo" src="" alt="Logo Squadra" class="w-20 h-20 rounded-full mx-auto mb-3 border-4 border-yellow-400 object-cover">
                    <p class="text-lg font-bold text-white mb-1" id="remembered-team-name">Nome Squadra</p>
                    <p class="text-xs text-gray-400 mb-4">Sessione attiva</p>
                    <button id="btn-reenter-dashboard"
                            class="w-full bg-green-500 text-gray-900 font-extrabold py-3 rounded-lg shadow-xl hover:bg-green-400 transition duration-150 transform hover:scale-[1.02] mb-2">
                        üè† Rientra in Dashboard
                    </button>
                    <button id="btn-full-logout"
                            class="w-full bg-red-600 text-white font-semibold py-2 rounded-lg shadow-md hover:bg-red-500 transition duration-150">
                        üö™ Logout Completo
                    </button>
                </div>
            </div>

            <!-- BOX 1: LOGIN -->
            <div id="normal-login-box" class="p-4 bg-gray-700 rounded-lg border-2 border-yellow-600 mb-4">
                <h3 class="text-sm font-bold text-yellow-400 mb-3 text-center">Login Squadra</h3>
                <input type="text" id="login-username" placeholder="Nome Squadra"
                       class="w-full p-3 border border-yellow-600 rounded-lg focus:ring-yellow-400 focus:border-yellow-400 bg-gray-800 text-white mb-3 shadow-inner-dark">

                <input type="password" id="login-password" placeholder="Password"
                       class="w-full p-3 border border-yellow-600 rounded-lg focus:ring-yellow-400 focus:border-yellow-400 bg-gray-800 text-white mb-3 shadow-inner-dark">

                <button id="login-button"
                        class="w-full bg-yellow-400 text-gray-900 font-extrabold py-3 rounded-lg shadow-xl hover:bg-yellow-300 transition duration-150 transform hover:scale-[1.02]">
                    Accedi
                </button>
                <p id="login-message" class="text-center mt-2 text-red-400 text-sm"></p>
            </div>

            <!-- BOX 2: ESPLORA LEGA -->
            <div class="p-4 bg-gray-700 rounded-lg border-2 border-blue-500 mb-4">
                <h3 class="text-sm font-bold text-blue-400 mb-3 text-center">Esplora la Lega</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button id="btn-leaderboard"
                            class="w-full bg-blue-600 text-white font-semibold py-2 rounded-lg shadow-md hover:bg-blue-500 transition duration-150 transform hover:scale-[1.02]">
                        üìä Classifica
                    </button>
                    <button id="btn-schedule"
                            class="w-full bg-teal-600 text-white font-semibold py-2 rounded-lg shadow-md hover:bg-teal-500 transition duration-150 transform hover:scale-[1.02]">
                        üìÖ Calendario
                    </button>
                    <button id="btn-coppa-home"
                            class="w-full bg-purple-600 text-white font-semibold py-2 rounded-lg shadow-md hover:bg-purple-500 transition duration-150 transform hover:scale-[1.02]">
                        üèÜ CoppaSeriA
                    </button>
                    <button id="btn-supercoppa-home"
                            class="w-full bg-amber-600 text-white font-semibold py-2 rounded-lg shadow-md hover:bg-amber-500 transition duration-150 transform hover:scale-[1.02]">
                        ‚≠ê SuperCoppa
                    </button>
                    <button id="btn-lista-icone"
                            class="w-full bg-yellow-600 text-white font-semibold py-2 rounded-lg shadow-md hover:bg-yellow-500 transition duration-150 transform hover:scale-[1.02]">
                        üëë Icone
                    </button>
                    <button id="btn-lista-squadre"
                            class="w-full bg-green-600 text-white font-semibold py-2 rounded-lg shadow-md hover:bg-green-500 transition duration-150 transform hover:scale-[1.02]">
                        üìã Squadre
                    </button>
                </div>
            </div>

            <!-- BOX 3: SUPPORTO -->
            <div class="p-4 bg-gray-700 rounded-lg border-2 border-red-500">
                <h3 class="text-sm font-bold text-red-400 mb-3 text-center">Supporto</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button id="btn-how-to-create-team"
                            onclick="window.Tutorial?.startHowToCreateTeam()"
                            class="bg-purple-600 text-white font-semibold py-2 rounded-lg shadow-md hover:bg-purple-500 transition duration-150 transform hover:scale-[1.02] text-center text-xs">
                        üìñ Come creare la mia squadra
                    </button>
                    <a href="https://docs.google.com/forms/d/1Iz3CJrVfeNrzR_rU5kmIC-WNCGbDo91yuM5i94P6fnY/edit"
                       target="_blank"
                       class="bg-red-600 text-white font-semibold py-2 rounded-lg shadow-md hover:bg-red-500 transition duration-150 transform hover:scale-[1.02] text-center text-xs flex items-center justify-center">
                        üêõ Segnala Bug
                    </a>
                </div>
                <div class="mt-3 flex justify-center">
                    <button id="btn-show-changelog"
                            onclick="window.Changelog?.showPlayers()"
                            class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-500 transition duration-150 transform hover:scale-[1.02] text-xs flex items-center justify-center gap-2">
                        <span>üìã</span> Novita <span class="bg-indigo-800 px-2 py-0.5 rounded-full text-[10px]">v0.9.95</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 3. CONTENUTO PRINCIPALE DELL'APP - Dashboard Squadra -->
        <div id="app-content" class="football-box w-full max-w-2xl transition duration-500 hidden-on-load relative">

            <!-- SELETTORE COLORE PRIMARIO -->
            <div id="team-color-picker-container" class="absolute top-2 right-2">
                <input type="color" id="team-color-picker"
                       class="w-8 h-8 rounded cursor-pointer border-2 border-gray-600 hover:border-white transition"
                       title="Scegli il colore primario della squadra"
                       value="#22c55e">
            </div>

            <!-- BOX NOME SQUADRA -->
            <div class="flex justify-center mb-4">
                <div class="py-3 px-8 bg-gray-700 rounded-lg shadow-xl border-2 border-green-500">
                    <h2 id="team-dashboard-title" class="text-3xl font-extrabold text-center uppercase" style="color: #22c55e;">NOME SQUADRA</h2>
                </div>
            </div>

            <!-- COUNTDOWN, LOGO, ICONA E DIVISA -->
            <div id="team-logo-container" class="flex justify-center items-center gap-4 mb-6">
                <!-- BOX SPONSOR (random) -->
                <div id="sponsor-box" class="relative w-28 h-28 flex-shrink-0">
                    <img id="sponsor-image"
                         src="https://placehold.co/128x128/374151/9ca3af?text=Sponsor"
                         alt="Sponsor"
                         class="w-full h-full rounded-lg border-4 shadow-lg object-cover bg-gray-800"
                         style="border-color: #22c55e;"
                         title="Sponsor">
                </div>
                <!-- BOX COUNTDOWN PROSSIMA PARTITA -->
                <div id="next-match-countdown" class="p-2 bg-gray-800 rounded-full border-4 border-teal-500 text-center shadow-lg w-28 h-28 flex flex-col justify-center items-center">
                    <p id="countdown-label-top" class="text-xs text-teal-300 font-semibold">Prossima</p>
                    <p id="countdown-timer" class="text-lg font-extrabold text-teal-400">--:--</p>
                    <p id="countdown-label-bottom" class="text-xs text-gray-500">Partita</p>
                </div>
                <div id="team-logo-wrapper" class="relative w-28 h-28">
                    <img id="team-logo"
                         src="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/placeholder.jpg"
                         alt="Logo Squadra Modificabile"
                         class="w-full h-full rounded-full border-4 cursor-pointer hover:opacity-80 transition duration-150 shadow-lg object-cover"
                         style="border-color: #22c55e;"
                         title="Clicca per cambiare il logo (Inserisci URL)">
                </div>
                <div class="relative group">
                    <img id="team-icona-avatar"
                         src="https://placehold.co/128x128/facc15/000?text=?"
                         alt="Avatar Icona"
                         class="w-28 h-28 rounded-full border-4 border-yellow-400 shadow-lg object-cover cursor-pointer">
                    <!-- Tooltip personalizzato -->
                    <div id="icona-tooltip" class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-50">
                        <p id="icona-tooltip-name" class="font-bold text-yellow-400">Icona</p>
                        <p id="icona-tooltip-level">Livello: --</p>
                        <p id="icona-tooltip-role">Ruolo: --</p>
                        <p id="icona-tooltip-type">Tipo: --</p>
                    </div>
                </div>
                <!-- BOX DIVISA SQUADRA -->
                <div id="team-uniform-box" class="p-2 bg-gray-800 rounded-full border-4 border-purple-500 text-center shadow-lg w-28 h-28 flex flex-col justify-center items-center cursor-pointer hover:border-purple-400 hover:bg-gray-700 transition duration-150" title="Clicca per modificare la divisa">
                    <svg id="uniform-preview-svg" viewBox="15 0 170 165" class="w-20 h-20">
                        <defs></defs>
                        <!-- Maglia stile jersey.xml -->
                        <g id="shirt-preview" transform="translate(0, 5)">
                            <!-- Corpo maglia con maniche integrate -->
                            <path id="dash-shirt-body" d="M 70,10 L 30,50 L 50,75 L 70,65 L 70,150 L 130,150 L 130,65 L 150,75 L 170,50 L 130,10 C 120,25 80,25 70,10 Z"
                                fill="#22c55e" stroke="#1a1a2e" stroke-width="2"/>
                            <!-- Colletto -->
                            <path id="dash-shirt-collar" d="M 70,10 C 80,25 120,25 130,10 C 125,18 75,18 70,10 Z"
                                fill="#ffffff" stroke="#1a1a2e" stroke-width="1"/>
                            <!-- Polsino sinistro -->
                            <path id="dash-shirt-cuff-left" d="M 30,50 L 50,75 L 45,80 L 25,55 Z"
                                fill="#ffffff" stroke="#1a1a2e" stroke-width="1"/>
                            <!-- Polsino destro -->
                            <path id="dash-shirt-cuff-right" d="M 170,50 L 150,75 L 155,80 L 175,55 Z"
                                fill="#ffffff" stroke="#1a1a2e" stroke-width="1"/>
                        </g>
                    </svg>
                    <p class="text-xs text-purple-300 mt-0">Divisa</p>
                </div>
                <!-- BOX MEDIA (random) -->
                <div id="media-box" class="relative w-28 h-28 flex-shrink-0">
                    <img id="media-image"
                         src="https://placehold.co/128x128/374151/9ca3af?text=Media"
                         alt="Media"
                         class="w-full h-full rounded-lg border-4 shadow-lg object-cover bg-gray-800"
                         style="border-color: #22c55e;"
                         title="Media Partner">
                </div>
            </div>

            <!-- RIEPILOGO STATISTICHE SQUADRA + HALL OF FAME (piccoli) -->
            <div class="flex justify-center gap-3 mt-6 w-2/3 mx-auto">
                <!-- Statistica: Livello Medio Rosa -->
                <div class="flex-1 py-2 px-2 bg-gray-700 rounded-lg shadow-xl text-center">
                    <p class="text-xs text-gray-300 font-semibold">üìà Livello Rosa</p>
                    <p class="mt-0.5"><span id="stat-rosa-level" class="text-lg font-extrabold text-white">N/A</span> <span id="stat-rosa-count" class="text-xs text-gray-400">(0)</span></p>
                </div>
                <!-- Bottone Hall of Fame -->
                <button id="btn-hall-of-fame"
                        class="flex-1 py-2 px-2 bg-gradient-to-r from-amber-600 via-yellow-500 to-amber-600 text-gray-900 font-extrabold text-xs rounded-lg shadow-xl hover:from-amber-500 hover:via-yellow-400 hover:to-amber-500 transition duration-150 transform hover:scale-[1.02] flex flex-col items-center justify-center border border-yellow-300">
                    <span class="text-lg">üèõÔ∏è</span>
                    <span>Hall of Fame</span>
                </button>
                <!-- Statistica 2: Livello Medio Formazione (nascosto) -->
                <div class="hidden">
                    <p id="stat-formazione-level">N/A</p>
                </div>
            </div>

            <!-- PULSANTI GESTIONE ROSA E FORMAZIONE (grandi) -->
            <div class="mt-4 grid grid-cols-2 gap-4">
                <button id="btn-gestione-rosa"
                        class="bg-gradient-to-r from-pink-600 to-rose-500 text-white font-extrabold py-6 text-xl rounded-lg shadow-xl hover:from-pink-500 hover:to-rose-400 transition duration-150 transform hover:scale-[1.02]">
                    üë• Gestione Rosa
                </button>
                <button id="btn-gestione-formazione"
                        class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-extrabold py-6 text-xl rounded-lg shadow-xl hover:from-indigo-500 hover:to-purple-500 transition duration-150 transform hover:scale-[1.02]">
                    üìã Gestione Formazione
                </button>
            </div>

            <!-- PULSANTI COMPETIZIONI (SerieSeriA, CoppaSeriA, Super CoppaSeriA) -->
            <div class="mt-4 space-y-3">
                <button id="btn-user-campionato"
                        class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white font-extrabold py-4 rounded-lg shadow-xl hover:from-green-500 hover:to-green-600 transition duration-150 transform hover:scale-[1.01] flex items-center justify-center gap-3">
                    <span class="text-2xl">üèÖ</span>
                    <span class="text-xl">SerieSeriA</span>
                </button>
                <button id="btn-user-coppa"
                        class="w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white font-extrabold py-4 rounded-lg shadow-xl hover:from-purple-500 hover:to-purple-600 transition duration-150 transform hover:scale-[1.01] flex items-center justify-center gap-3">
                    <span class="text-2xl">üèÜ</span>
                    <span class="text-xl">CoppaSeriA</span>
                </button>
                <button id="btn-user-supercoppa"
                        class="w-full bg-gradient-to-r from-orange-700 to-amber-600 text-white font-extrabold py-4 rounded-lg shadow-xl hover:from-orange-600 hover:to-amber-500 transition duration-150 transform hover:scale-[1.01] flex items-center justify-center gap-3">
                    <span class="text-2xl">‚≠ê</span>
                    <span class="text-xl">Super CoppaSeriA</span>
                </button>
            </div>

            <!-- PULSANTI DRAFT E MERCATO CON BUDGET SU HOVER -->
            <div id="draft-mercato-container" class="mt-4 relative group">
                <!-- Riga 1: Draft e Mercato -->
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <button id="btn-draft-utente"
                            class="bg-gradient-to-r from-yellow-600 to-amber-500 text-white font-extrabold py-3 rounded-lg shadow-xl hover:from-yellow-500 hover:to-amber-400 transition duration-150 transform hover:scale-[1.01]">
                        üìù Draft
                    </button>
                    <button id="btn-mercato-utente"
                            class="bg-gradient-to-r from-blue-600 to-cyan-500 text-white font-extrabold py-3 rounded-lg shadow-xl hover:from-blue-500 hover:to-cyan-400 transition duration-150 transform hover:scale-[1.01]">
                        üí∞ Mercato
                    </button>
                </div>
                <!-- Riga 2: Sfida e Allenamento -->
                <div class="grid grid-cols-2 gap-4">
                    <button id="btn-challenge"
                            class="bg-gradient-to-r from-orange-600 to-red-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:from-orange-500 hover:to-red-500 transition duration-150 transform hover:scale-[1.01] flex items-center justify-center gap-2">
                        <span>‚öîÔ∏è</span> Sfida
                    </button>
                    <button id="btn-training"
                            class="bg-gradient-to-r from-green-600 to-emerald-500 text-white font-extrabold py-3 rounded-lg shadow-xl hover:from-green-500 hover:to-emerald-400 transition duration-150 transform hover:scale-[1.01] flex items-center justify-center gap-2">
                        <span>‚öΩ</span> Allenamento
                    </button>
                </div>
                <!-- BOX BUDGET (nascosto, visibile su hover) -->
                <div class="hidden group-hover:flex justify-center mt-3">
                    <div id="team-budget-box" class="w-1/2 p-2 bg-gradient-to-r from-yellow-900 to-amber-800 rounded-lg border border-yellow-500 text-center shadow-lg transition-all duration-300">
                        <p class="text-xs text-yellow-200 font-semibold">Budget Disponibile</p>
                        <p id="team-budget-value" class="text-xl font-extrabold text-yellow-400">-- CS</p>
                    </div>
                </div>
            </div>

            <!-- CONTAINER CREDITI SUPER SERI -->
            <div id="css-dashboard-widget" class="mt-4">
                <!-- Il widget CSS viene renderizzato qui dinamicamente -->
            </div>

            <!-- Toggle Partecipazione Campionato e Coppa -->
            <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Toggle Campionato -->
                <div class="p-4 bg-gray-700 rounded-lg border-2 border-green-500 text-center shadow-lg">
                    <div class="flex items-center justify-center space-x-3 mb-2">
                        <span class="text-white font-bold">üèÖ Campionato</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="championship-participation-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                        </label>
                    </div>
                    <p id="championship-participation-status" class="text-xs text-gray-400">
                        Caricamento stato...
                    </p>
                </div>

                <!-- Toggle CoppaSeriA -->
                <div class="p-4 bg-gray-700 rounded-lg border-2 border-purple-500 text-center shadow-lg">
                    <div class="flex items-center justify-center space-x-3 mb-2">
                        <span class="text-white font-bold">üèÜ CoppaSeriA</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="cup-participation-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-500"></div>
                        </label>
                    </div>
                    <p id="cup-participation-status" class="text-xs text-gray-400">
                        Caricamento stato...
                    </p>
                </div>
            </div>

            <span id="team-firestore-id" class="hidden">N/A</span>

            <div class="grid grid-cols-2 gap-4 mt-6">
                <button id="user-back-to-login-button"
                        class="w-full bg-yellow-500 text-gray-900 font-extrabold py-3 rounded-lg shadow-xl hover:bg-yellow-400 transition duration-150 transform hover:scale-[1.02]">
                    üîô Torna al Login
                </button>
                <!-- NUOVO PULSANTE ELIMINA SQUADRA -->
                <button id="btn-delete-team"
                        class="w-full bg-red-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-red-500 transition duration-150 transform hover:scale-[1.02]">
                    üóëÔ∏è Elimina Squadra
                </button>
            </div>

            <!-- Bottone Torna al Pannello Admin - Visibile SOLO se si accede dalla dashboard admin -->
            <div id="admin-return-button-container" class="mt-4 hidden">
                <button id="btn-return-to-admin"
                        class="w-full bg-indigo-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-indigo-500 transition duration-150 transform hover:scale-[1.02]">
                    üîß Torna al Pannello Admin
                </button>
            </div>

            <!-- Pulsante Tutorial - In fondo alla dashboard -->
            <div class="mt-6 flex justify-center">
                <button id="btn-start-tutorial"
                        onclick="window.Tutorial?.start()"
                        class="bg-purple-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-purple-500 transition duration-150 transform hover:scale-[1.02] flex items-center justify-center gap-2">
                    <span>üìñ</span> Tutorial
                </button>
            </div>

            <!-- Pulsante Aggiorna App - Visibile solo quando installata come PWA -->
            <div id="pwa-update-button-container" class="mt-4 flex justify-center hidden">
                <button id="btn-check-pwa-update"
                        class="bg-cyan-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-cyan-500 transition duration-150 transform hover:scale-[1.02] flex items-center justify-center gap-2">
                    <span>üîÑ</span> Controlla Aggiornamenti
                </button>
            </div>
        </div>
        
        <!-- 4. CONTENUTO AREA AMMINISTRATORE - Dashboard Principale -->
        <div id="admin-content" class="football-box w-full max-w-3xl transition duration-500 hidden-on-load">
            <!-- Contenitore per i pulsanti principali e liste squadre -->
            <div id="admin-dashboard-container" class="p-6 bg-gray-700 rounded-lg border-2 border-red-500 shadow-xl">
                <!-- Il layout √® generato da admin.js -->
                <p class="text-gray-400 text-center">Inizializzazione...</p>
            </div>
            
            <div class="mt-6 flex gap-3">
                <button id="btn-admin-changelog"
                        onclick="window.Changelog?.showAdmin()"
                        class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-xl hover:bg-indigo-500 transition duration-150 transform hover:scale-[1.02] flex items-center justify-center gap-2">
                    <span>üìã</span> Changelog
                </button>
                <button id="admin-logout-button"
                        class="flex-1 bg-red-500 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-red-400 transition duration-150 transform hover:scale-[1.02]">
                    Logout Admin
                </button>
            </div>
        </div>
        
        <!-- 5. CONTENUTO AREA DRAFT (Utente) - NASCOSTO -->
        <div id="draft-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load">
             <h2 class="text-4xl font-extrabold text-yellow-400 text-center mb-4 border-b-4 border-yellow-700 pb-2">Gestione Draft Calciatori</h2>
             <div id="draft-tools-container" class="mt-6">
                <p class="text-center text-gray-400">Strumenti di gestione Draft in caricamento...</p>
             </div>
             <button id="draft-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Indietro
            </button>
        </div>
        
        <!-- 6. CONTENUTO AREA CLASSIFICA - NASCOSTO -->
        <div id="leaderboard-content" class="football-box w-full max-w-2xl transition duration-500 hidden-on-load">
             <h2 class="text-4xl font-extrabold text-blue-400 text-center mb-4 border-b-4 border-blue-700 pb-2">Classifica Generale Lega</h2>
             <p class="text-center text-lg text-gray-300">Qui vedrai la classifica aggiornata di tutte le squadre.</p>
             <div class="mt-8 p-6 bg-gray-700 rounded-lg border-2 border-blue-500 text-center shadow-lg">
                <p class="text-white font-semibold">I dati della classifica saranno caricati qui.</p>
             </div>
             <button id="leaderboard-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Torna al Login
            </button>
        </div>
        
        <!-- 7. CONTENUTO AREA CALENDARIO - NASCOSTO -->
        <div id="schedule-content" class="football-box w-full max-w-2xl transition duration-500 hidden-on-load">
             <h2 class="text-4xl font-extrabold text-teal-400 text-center mb-4 border-b-4 border-teal-700 pb-2">Calendario Partite</h2>
             <p class="text-center text-lg text-gray-300">Consulta qui le sfide e i risultati di ogni giornata.</p>
             <div class="mt-8 p-6 bg-gray-700 rounded-lg border-2 border-teal-500 text-center shadow-lg">
                <p class="text-white font-semibold">I dati del calendario saranno caricati qui.</p>
             </div>
             <button id="schedule-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Torna al Login
            </button>
        </div>
        
        <!-- 7B. CONTENUTO AREA CAMPIONATO UTENTE (NUOVA) -->
        <div id="user-campionato-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load">
             <h2 class="text-4xl font-extrabold text-green-400 text-center mb-4 border-b-4 border-green-700 pb-2">üèÜ SerieSeriA</h2>
             <p class="text-center text-lg text-gray-300 mb-6">Prossima partita, classifica e calendario</p>
             <div id="user-campionato-container" class="mt-6 space-y-6">
                <p class="text-center text-gray-400">Caricamento dati campionato...</p>
             </div>
             <button id="user-campionato-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                ‚Üê Torna alla Dashboard
            </button>
        </div>

        <!-- 7C. CONTENUTO AREA COPPA UTENTE (NUOVA) -->
        <div id="user-coppa-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load">
             <h2 class="text-4xl font-extrabold text-purple-400 text-center mb-4 border-b-4 border-purple-700 pb-2">üèÜ CoppaSeriA</h2>
             <p class="text-center text-lg text-gray-300 mb-6">Prossima partita e tabellone</p>
             <div id="user-coppa-container" class="mt-6 space-y-6">
                <p class="text-center text-gray-400">Caricamento dati coppa...</p>
             </div>
             <button id="user-coppa-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                ‚Üê Torna alla Dashboard
            </button>
        </div>

        <!-- 7D. CONTENUTO AREA SUPERCOPPA UTENTE (NUOVA) -->
        <div id="user-supercoppa-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load">
             <h2 class="text-4xl font-extrabold text-yellow-400 text-center mb-4 border-b-4 border-yellow-700 pb-2">‚≠ê Super CoppaSeriA</h2>
             <p class="text-center text-lg text-gray-300 mb-6">Stato e risultato della Super CoppaSeriA</p>
             <div id="user-supercoppa-container" class="mt-6 space-y-6">
                <p class="text-center text-gray-400">Caricamento dati supercoppa...</p>
             </div>
             <button id="user-supercoppa-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                ‚Üê Torna alla Dashboard
            </button>
        </div>

        <!-- 7E. CONTENUTO AREA CAMPIONATO UTENTE (VECCHIO - DA RIMUOVERE) -->
        <div id="user-championship-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load">
             <h2 class="text-4xl font-extrabold text-purple-400 text-center mb-4 border-b-4 border-purple-700 pb-2">üèÜ Gestione Campionato</h2>
             <p class="text-center text-lg text-gray-300 mb-6">Simula le partite della tua lega e segui l'andamento</p>
             <div id="user-championship-tools-container" class="mt-6">
                <p class="text-center text-gray-400">Strumenti di simulazione in caricamento...</p>
             </div>
             <button id="user-championship-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Torna alla Dashboard
            </button>
        </div>

        <!-- 8. CONTENUTO AREA IMPOSTAZIONI CAMPIONATO - NASCOSTO -->
        <div id="championship-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load">
             <h2 class="text-4xl font-extrabold text-orange-400 text-center mb-4 border-b-4 border-orange-700 pb-2">Impostazioni e Regole Campionato</h2>
             <div id="championship-tools-container" class="mt-6">
                <p class="text-center text-gray-400">Strumenti di gestione Campionato in caricamento...</p>
             </div>
             <button id="championship-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Torna al Pannello Admin
            </button>
        </div>

        <!-- 9. CONTENUTO AREA GESTIONE SQUADRA (Rosa e Formazione) -->
        <div id="squadra-content" class="football-box w-full max-w-5xl transition duration-500 hidden-on-load">
             <h2 id="squadra-main-title" class="text-4xl font-extrabold text-green-400 text-center mb-4 border-b-4 border-green-700 pb-2">Gestione Rosa</h2>
             <p id="squadra-subtitle" class="text-center text-lg text-gray-300 mb-6">Visualizza e gestisci i tuoi calciatori.</p>
             
             <!-- Contenitore logica Gestione Rosa o Formazione -->
             <div id="squadra-tools-container" class="mt-6">
                <p class="text-center text-gray-400">Contenuto in caricamento...</p>
             </div>
             
             <button id="squadra-back-button"
                    class="mt-6 w-full bg-yellow-500 text-gray-900 font-extrabold py-3 rounded-lg shadow-xl hover:bg-yellow-400 transition duration-150 transform hover:scale-[1.02]">
                Torna alla Dashboard
            </button>
        </div>

        <!-- 10. CONTENUTO AREA MERCATO (Acquisti Liberi) - NASCOSTO -->
        <div id="mercato-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load">
             <h2 class="text-4xl font-extrabold text-blue-400 text-center mb-4 border-b-4 border-blue-700 pb-2">Mercato Fuori Lista</h2>
             <div id="mercato-tools-container" class="mt-6">
                <p class="text-center text-gray-400">Contenuto Mercato in caricamento...</p>
             </div>
             <button id="mercato-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Torna alla Dashboard
            </button>
        </div>

        <!-- 10b. CONTENUTO HALL OF FAME (Storico Partite) - NASCOSTO -->
        <div id="match-history-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load">
             <h2 class="text-4xl font-extrabold text-amber-400 text-center mb-4 border-b-4 border-amber-600 pb-2">üèõÔ∏è Hall of Fame</h2>
             <div id="match-history-tools-container" class="mt-6">
                <p class="text-center text-gray-400">Caricamento storico partite...</p>
             </div>
             <button id="match-history-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Torna alla Dashboard
            </button>
        </div>

        <!-- 11. CONTENUTO: GESTIONE GIOCATORI ADMIN -->
        <div id="player-management-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load">
             <h2 class="text-4xl font-extrabold text-yellow-400 text-center mb-4 border-b-4 border-yellow-700 pb-2">Gestione Calciatori (Creazione e Liste)</h2>
             
             <!-- Il contenuto √® iniettato da admin.js -->
             <div id="player-management-tools-container" class="mt-6">
                <p class="text-center text-gray-400">Caricamento strumenti...</p>
             </div>

             <button id="player-management-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Torna alla Dashboard Admin
            </button>
        </div>

        <!-- 12. NUOVO CONTENUTO: GESTIONE SQUADRE ADMIN -->
        <div id="team-management-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load">
             <h2 class="text-4xl font-extrabold text-blue-500 text-center mb-4 border-b-4 border-blue-700 pb-2">Gestione Squadre Registrate</h2>
             
             <!-- Il contenuto √® iniettato da admin.js -->
             <div id="team-management-tools-container" class="mt-6">
                <p class="text-center text-gray-400">Caricamento strumenti...</p>
             </div>

             <button id="team-management-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Torna alla Dashboard Admin
            </button>
        </div>

        <!-- 12b. NUOVO CONTENUTO: GESTIONE FEATURE FLAGS -->
        <div id="feature-flags-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load">
             <h2 class="text-4xl font-extrabold text-purple-500 text-center mb-4 border-b-4 border-purple-700 pb-2">
                <i class="fas fa-flag mr-2"></i> Gestione Feature Flags
             </h2>

             <!-- Il contenuto e' iniettato da admin-feature-flags.js -->
             <div id="feature-flags-tools-container" class="mt-6">
                <p class="text-center text-gray-400">Caricamento strumenti...</p>
             </div>

             <button id="feature-flags-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Torna alla Dashboard Admin
            </button>
        </div>

        <!-- 13. NUOVO CONTENUTO: SELEZIONE ALLENATORE -->
        <div id="coach-selection-box" class="football-box w-full max-w-xl transition duration-500 hidden-on-load">
            <h2 class="text-4xl font-extrabold text-red-500 text-center mb-4 border-b-4 border-red-700 pb-2">Un Manager per la Tua Squadra</h2>
            <p class="text-center text-lg text-gray-300 mb-6">Inserisci il nome dell'allenatore che guider√† la squadra. Partir√† da Livello 1 e Potr√† crescere.</p>
            
            <input type="text" id="coach-name-input" placeholder="Nome Allenatore (es. Carlo Ancelotti)"
                   class="w-full p-3 border border-red-600 rounded-lg focus:ring-red-400 focus:border-red-400 bg-gray-700 text-white mb-4 shadow-inner-dark">
            
            <button id="btn-confirm-coach"
                    class="w-full bg-red-500 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-red-400 transition duration-150 transform hover:scale-[1.02]">
                Conferma e Scegli l'Icona
            </button>
            
            <p id="coach-selection-message" class="text-center mt-3 text-red-400"></p>
        </div>
        
        <!-- 14. CONTENUTO: SELEZIONE ICONA -->
        <div id="captain-selection-box" class="football-box w-full max-w-3xl transition duration-500 hidden-on-load">
             <h2 class="text-4xl font-extrabold text-orange-400 text-center mb-4 border-b-4 border-orange-700 pb-2">Seleziona la tua Icona!</h2>
             <p id="captain-message" class="text-center text-lg text-gray-300 mb-6">Scegli l'Icona che guider√† la tua squadra. Sar√† il tuo giocatore speciale in rosa.</p>
             
             <div id="captain-candidates-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                <p class="text-center text-gray-400 col-span-4">Caricamento candidati...</p>
             </div>
             
             <p id="captain-selection-error" class="text-center mt-6 text-red-400"></p>
             
             <button id="btn-confirm-captain"
                    class="mt-6 w-full bg-green-500 text-gray-900 font-extrabold py-3 rounded-lg shadow-xl hover:bg-green-400 transition duration-150 transform hover:scale-[1.02]" disabled>
                Conferma Icona e Vai alla Dashboard
            </button>
        </div>
        
        
        <!-- 15. MODALE DI CONFERMA ELIMINAZIONE SQUADRA (Globale) -->
        <div id="delete-team-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50 hidden">
            <div class="football-box w-full max-w-sm">
                <h3 class="text-3xl font-bold text-red-400 mb-4 border-b border-red-600 pb-2 text-center">ELIMINA SQUADRA</h3>
                <p class="text-lg text-gray-300 mb-4 text-center">Sei sicuro di voler eliminare definitivamente <span id="team-name-to-delete" class="font-extrabold text-yellow-400">[Nome Squadra]</span>?</p>
                
                <p class="text-red-400 font-bold mb-4 text-center">Questa azione √® irreversibile.</p>

                <label for="delete-confirmation-input" class="block text-gray-300 font-semibold mb-2">Digita "ELIMINA" per confermare:</label>
                <input type="text" id="delete-confirmation-input" 
                       class="w-full p-3 mb-4 rounded-lg bg-gray-700 border border-red-600 text-white uppercase text-center font-extrabold focus:ring-red-400">

                <div class="flex justify-between space-x-4">
                    <button id="btn-cancel-delete"
                            class="w-1/2 bg-gray-500 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-gray-400 transition duration-150">
                        Annulla
                    </button>
                    <button id="btn-confirm-delete-final"
                            class="w-1/2 bg-red-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-red-500 transition duration-150" disabled>
                        Conferma Eliminazione
                    </button>
                </div>
                <p id="delete-message" class="text-center mt-3 text-red-400"></p>
            </div>
        </div>

        <!-- 16. MODALE LISTA ICONE -->
        <div id="lista-icone-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-start justify-center p-2 pt-4 z-50 hidden overflow-y-auto">
            <div class="football-box w-full max-w-4xl mx-auto mb-4 max-h-[95vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4 border-b border-yellow-600 pb-2 sticky top-0 bg-gray-800 pt-2 -mt-2 z-10">
                    <h3 class="text-2xl md:text-3xl font-bold text-yellow-400">üëë Lista Icone</h3>
                    <button id="btn-close-lista-icone" class="text-white hover:text-red-400 text-3xl font-bold">‚úï</button>
                </div>
                <p class="text-gray-300 mb-4 text-center text-sm">Scegli un'Icona quando crei la tua squadra!</p>
                <div id="lista-icone-container" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <!-- Le icone vengono caricate dinamicamente -->
                </div>
                <button id="btn-back-to-login"
                        class="mt-4 w-full bg-yellow-500 text-gray-900 font-extrabold py-3 rounded-lg shadow-xl hover:bg-yellow-400 transition duration-150">
                    Chiudi
                </button>
            </div>
        </div>

        <!-- 16B. MODALE LISTA SQUADRE -->
        <div id="lista-squadre-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-start justify-center p-2 pt-4 z-50 hidden overflow-y-auto">
            <div class="football-box w-full max-w-4xl mx-auto mb-4 max-h-[95vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4 border-b border-green-600 pb-2 sticky top-0 bg-gray-800 pt-2 -mt-2 z-10">
                    <h3 class="text-2xl md:text-3xl font-bold text-green-400">üìã Squadre</h3>
                    <button id="btn-close-lista-squadre" class="text-white hover:text-red-400 text-3xl font-bold">‚úï</button>
                </div>
                <p class="text-gray-300 mb-4 text-center text-sm">Tutte le squadre della lega</p>
                <div id="lista-squadre-container" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <!-- Le squadre vengono caricate dinamicamente -->
                    <p class="text-center text-gray-400 col-span-2">Caricamento squadre...</p>
                </div>
                <button id="btn-back-from-squadre"
                        class="mt-4 w-full bg-green-500 text-gray-900 font-extrabold py-3 rounded-lg shadow-xl hover:bg-green-400 transition duration-150">
                    Chiudi
                </button>
            </div>
        </div>

        <!-- 17. MODALE EDITOR DIVISA -->
        <div id="uniform-editor-modal" class="fixed inset-0 bg-black bg-opacity-90 items-center justify-center p-4 z-50 hidden overflow-y-auto">
            <div class="football-box w-full max-w-4xl mx-auto my-8">
                <div class="flex justify-between items-center mb-4 border-b border-purple-600 pb-2">
                    <h3 class="text-3xl font-bold text-purple-400">üëï Editor Divisa</h3>
                    <button id="btn-close-uniform-editor" class="text-white hover:text-red-400 text-3xl font-bold">‚úï</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- ANTEPRIMA DIVISA COMPLETA -->
                    <div class="bg-gray-800 rounded-lg p-4 border-2 border-gray-600">
                        <h4 class="text-lg font-bold text-white mb-4 text-center">Anteprima Divisa</h4>
                        <svg id="uniform-full-preview" viewBox="0 0 200 260" class="w-full max-w-xs mx-auto">
                            <!-- Definizioni pattern -->
                            <defs id="uniform-patterns-defs"></defs>

                            <!-- MAGLIA (stile jersey.xml) -->
                            <g id="editor-shirt-preview" transform="translate(0, 10)">
                                <!-- Corpo maglia con maniche integrate -->
                                <path id="editor-shirt-body" d="M 70,10 L 30,50 L 50,75 L 70,65 L 70,150 L 130,150 L 130,65 L 150,75 L 170,50 L 130,10 C 120,25 80,25 70,10 Z"
                                    fill="#22c55e" stroke="#1a1a2e" stroke-width="2"/>
                                <!-- Colletto -->
                                <path id="editor-shirt-collar" d="M 70,10 C 80,25 120,25 130,10 C 125,18 75,18 70,10 Z"
                                    fill="#ffffff" stroke="#1a1a2e" stroke-width="1.5"/>
                                <!-- Polsino sinistro -->
                                <path id="editor-shirt-cuff-left" d="M 30,50 L 50,75 L 45,80 L 25,55 Z"
                                    fill="#ffffff" stroke="#1a1a2e" stroke-width="1.5"/>
                                <!-- Polsino destro -->
                                <path id="editor-shirt-cuff-right" d="M 170,50 L 150,75 L 155,80 L 175,55 Z"
                                    fill="#ffffff" stroke="#1a1a2e" stroke-width="1.5"/>
                            </g>

                            <!-- PANTALONCINI (stile jersey.xml) -->
                            <g id="editor-shorts-preview" transform="translate(0, 170)">
                                <!-- Corpo pantaloncini -->
                                <path id="editor-shorts-body" d="M 65,0 L 135,0 L 145,70 L 105,70 L 100,40 L 95,70 L 55,70 L 65,0 Z"
                                    fill="#1a1a2e" stroke="#1a1a2e" stroke-width="2"/>
                                <!-- Striscia laterale sinistra -->
                                <path id="editor-shorts-stripe-left" d="M 65,0 L 55,70 L 60,70 L 70,0 Z"
                                    fill="#ffffff" stroke="none"/>
                                <!-- Striscia laterale destra -->
                                <path id="editor-shorts-stripe-right" d="M 135,0 L 145,70 L 140,70 L 130,0 Z"
                                    fill="#ffffff" stroke="none"/>
                            </g>
                        </svg>
                    </div>

                    <!-- CONTROLLI EDITOR -->
                    <div class="space-y-4">
                        <!-- MAGLIA -->
                        <div class="bg-gray-800 rounded-lg p-4 border-2 border-green-600">
                            <h4 class="text-lg font-bold text-green-400 mb-3">üëï Maglia</h4>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-sm text-gray-300 mb-1">Primario</label>
                                    <input type="color" id="shirt-color-primary" value="#22c55e" class="w-full h-10 rounded cursor-pointer border-2 border-gray-600">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-300 mb-1">Secondario</label>
                                    <input type="color" id="shirt-color-secondary" value="#ffffff" class="w-full h-10 rounded cursor-pointer border-2 border-gray-600">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-300 mb-1">Colletto</label>
                                    <input type="color" id="shirt-color-collar" value="#ffffff" class="w-full h-10 rounded cursor-pointer border-2 border-gray-600">
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="block text-sm text-gray-300 mb-1">Pattern</label>
                                <select id="shirt-pattern" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                                    <option value="solid">Tinta Unita</option>
                                    <option value="half-vertical">Meta Verticale</option>
                                    <option value="vertical-stripes">Strisce Verticali</option>
                                    <option value="horizontal-stripes">Strisce Orizzontali</option>
                                    <option value="diagonal-stripes">Strisce Diagonali</option>
                                    <option value="center-band-v">Banda Centrale Verticale</option>
                                    <option value="center-band-h">Banda Centrale Orizzontale</option>
                                    <option value="shoulders">Spalle Colorate</option>
                                    <option value="sleeves">Maniche Colorate</option>
                                    <option value="checkered">Scacchi</option>
                                </select>
                            </div>
                        </div>

                        <!-- PANTALONCINI -->
                        <div class="bg-gray-800 rounded-lg p-4 border-2 border-blue-600">
                            <h4 class="text-lg font-bold text-blue-400 mb-3">ü©≥ Pantaloncini</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm text-gray-300 mb-1">Primario</label>
                                    <input type="color" id="shorts-color-primary" value="#1a1a2e" class="w-full h-10 rounded cursor-pointer border-2 border-gray-600">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-300 mb-1">Secondario</label>
                                    <input type="color" id="shorts-color-secondary" value="#ffffff" class="w-full h-10 rounded cursor-pointer border-2 border-gray-600">
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="block text-sm text-gray-300 mb-1">Pattern</label>
                                <select id="shorts-pattern" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                                    <option value="solid">Tinta Unita</option>
                                    <option value="side-stripe">Strisce Laterali</option>
                                    <option value="half-vertical">Meta Verticale</option>
                                </select>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- PULSANTI AZIONI -->
                <div class="mt-6 flex gap-4">
                    <button id="btn-cancel-uniform"
                            class="flex-1 bg-gray-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-gray-500 transition duration-150">
                        Annulla
                    </button>
                    <button id="btn-save-uniform"
                            class="flex-1 bg-purple-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-purple-500 transition duration-150">
                        Salva Divisa
                    </button>
                </div>
                <p id="uniform-editor-message" class="text-center mt-3"></p>
            </div>
        </div>

        <!-- MODAL CHANGELOG -->
        <div id="changelog-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[9999] hidden flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-xl border-2 border-indigo-500 shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <div class="bg-indigo-600 px-6 py-4 flex justify-between items-center">
                    <h3 id="changelog-title" class="text-xl font-bold text-white flex items-center gap-2">
                        <span>üìã</span> Novita per i Giocatori
                    </h3>
                    <button onclick="window.Changelog?.hide()" class="text-white hover:text-gray-300 text-2xl font-bold">&times;</button>
                </div>
                <div id="changelog-content" class="p-6 overflow-y-auto flex-1">
                    <!-- Contenuto changelog inserito da JS -->
                </div>
                <div class="bg-gray-900 px-6 py-3 text-center">
                    <button onclick="window.Changelog?.hide()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-8 rounded-lg transition">
                        Chiudi
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- Logo che Scorrer√† con la Pagina - SPOSTATO ALL'INTERNO DI <main> -->
    <img id="footer-logo" 
         src="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/serie%20sera%20256.png" 
         alt="Logo in fondo alla pagina">

    <!-- INIZIALIZZAZIONE FIREBASE e AUTH/DB -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // *** IMPORTAZIONE CRITICA: Importa TUTTE le funzioni necessarie per l'oggetto firestoreTools ***
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, where, getDocs, deleteDoc, updateDoc, deleteField, onSnapshot, orderBy, limit, Timestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Imposta il livello di log (utile per il debug)
        setLogLevel('debug');

        // Variabili globali fornite dall'ambiente Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Configurazione e inizializzazione standard (inclusa la tua config come fallback per i test locali)
        window.firebaseConfig = {
            apiKey: "AIzaSyDL0n4qFzpPd3v-aoJoI_GJCQ_hlpwbaSA",
            authDomain: "lega-fantacalcio-unica-2024.firebaseapp.com",
            projectId: "lega-fantacalcio-unica-2024",
            storageBucket: "lega-fantacalcio-unica-2024.firebasestorage.app",
            messagingSenderId: "219665032240",
            appId: "1:219665032240:web:14cfa85e5186384cc339f5",
            measurementId: "G-4WFPVEF886",
            // Unisce la configurazione fornita dal Canvas (se disponibile e valida)
            ...(firebaseConfig || {})
        };
        
        // Inizializzazione Firebase
        window.app = initializeApp(window.firebaseConfig);
        window.db = getFirestore(window.app);
        window.auth = getAuth(window.app);
        
        // *** ESPOSIZIONE CRITICA (CORREZIONE) ***
        // Espone TUTTE le funzioni di Firestore a window.firestoreTools al momento dell'importazione.
        // Questo √® il punto chiave che garantisce la disponibilit√É∆í√Ü‚Äô√É‚Äö√Ç¬† di 'where'.
        window.firestoreTools = { doc, getDoc, setDoc, addDoc, collection, query, where, getDocs, deleteDoc, updateDoc, deleteField, onSnapshot, orderBy, limit, Timestamp, runTransaction, appId }; 
        
        // Funzione globale per cambiare schermata
        window.showScreen = (elementToShow) => {
            const boxes = [
                document.getElementById('gate-box'),
                document.getElementById('login-box'),
                document.getElementById('app-content'),
                document.getElementById('admin-content'),
                document.getElementById('draft-content'),
                document.getElementById('leaderboard-content'),
                document.getElementById('schedule-content'),
                document.getElementById('championship-content'),
                document.getElementById('squadra-content'),
                document.getElementById('mercato-content'),
                document.getElementById('match-history-content'), // Hall of Fame
                document.getElementById('player-management-content'), // Gestione Giocatori Admin
                document.getElementById('team-management-content'), // Gestione Squadre Admin
                document.getElementById('feature-flags-content'), // Gestione Feature Flags Admin
                document.getElementById('coach-selection-box'), // Selezione Allenatore (NUOVO)
                document.getElementById('captain-selection-box'), // Selezione Capitano
                document.getElementById('user-championship-content'), // Campionato Utente (vecchio)
                document.getElementById('user-campionato-content'), // SerieSeriA Utente
                document.getElementById('user-coppa-content'), // CoppaSeriA Utente
                document.getElementById('user-supercoppa-content') // Super CoppaSeriA Utente
            ];
            boxes.forEach(box => {
                if (box) {
                    box.classList.add('hidden');
                    box.classList.add('hidden-on-load');
                }
            });
            if (elementToShow) {
                elementToShow.classList.remove('hidden');
                elementToShow.classList.remove('hidden-on-load');
            }
        };


        // Funzione per l'autenticazione iniziale (necessaria per accedere a Firestore)
        async function initialAuth() {
            try {
                // Tenta di autenticare con il token fornito dall'ambiente (se presente)
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                    console.log("Autenticazione Firebase riuscita con token personalizzato.");
                } else {
                    // Altrimenti, usa l'accesso anonimo come fallback
                    await signInAnonymously(window.auth);
                    console.log("Autenticazione Firebase riuscita in modalit√É∆í√Ü‚Äô√É‚Äö√Ç¬† anonima.");
                }
            } catch (error) {
                console.error("Errore durante l'autenticazione iniziale:", error);
                // In caso di errore critico, si pu√É∆í√Ü‚Äô√É‚Äö√Ç¬≤ mostrare un messaggio di fallback all'utente
            }
        }
        
        initialAuth();

    </script>
    
    <!-- Collega gli script JavaScript esterni - DEVE ESSERE DOPO GLI SCRIPT FIREBASE -->
    
    <!-- 1. DEFINIZIONI BASE (Icone, Costanti, Variabili Globali) -->
    <script src="icone.js"></script>
    <script src="interfaccia-core.js"></script>

    <!-- 1.5 UTILITY UI (Toast, Dialogs, Loading, Validazione) -->
    <script src="toast.js"></script>
    <script src="confirm-dialog.js"></script>
    <script src="skeleton-loader.js"></script>
    <script src="loading-manager.js"></script>
    <script src="error-handler.js"></script>
    <script src="form-validator.js"></script>
    <script src="breadcrumb.js"></script>

    <!-- 1.6 FEATURE FLAGS SYSTEM (Sistema toggle funzionalita') -->
    <script src="feature-flags.js"></script>

    <!-- 1.7 MODULI FEATURE OPZIONALI (Controllati da Feature Flags) -->
    <script src="notifications.js"></script>
    <script src="player-stats-advanced.js"></script>
    <script src="chat.js"></script>
    <script src="trades.js"></script>
    <script src="achievements.js"></script>
    <script src="training.js"></script>
    <script src="match-animations.js"></script>
    <script src="drag-drop.js"></script>
    <script src="challenges.js"></script>
    <script src="challenge-match.js"></script>
    <script src="dashboard-features.js"></script>
    <script src="tutorial.js"></script>
    <script src="changelog.js"></script>
    <script src="match-history.js"></script>
    <script src="image-compressor.js"></script>
    <script src="lazy-loader.js"></script>
    <script src="tests.js"></script>

    <!-- 2. LOGICA DI SIMULAZIONE (Dipende solo dalle costanti) -->
    <script src="simulazione.js"></script> 

    <!-- 3. MODULI CORE INTERFACCIA (Dipendono da Core) -->
    <script src="interfaccia-auth.js"></script>       
    <script src="interfaccia-dashboard.js"></script>
    <script src="interfaccia-navigation.js"></script>
    <script src="interfaccia-onboarding.js"></script>
    <script src="interfaccia-team.js"></script>

    <!-- MODULI GESTIONE SQUADRE (in ordine di dipendenza) -->
    <script src="gestionesquadre-constants.js"></script>
    <script src="gestionesquadre-utils.js"></script>
    <script src="gestionesquadre-rosa.js"></script>
    <script src="gestionesquadre-formazione.js"></script>
    <script src="gestionesquadre-icona.js"></script>
    <script src="gestionesquadre.js"></script> <!-- Orchestratore -->
    
    <!-- 4. LOGICHE DI ACQUISTO (Dipendono da Core e possibilmente da Auth/Team) -->
    <!-- MODULI DRAFT (in ordine di dipendenza) -->
    <script src="draft-constants.js"></script>
    <script src="draft-utils.js"></script>
    <script src="draft-turns.js"></script>
    <script src="draft-admin-ui.js"></script>
    <script src="draft-admin-players.js"></script>
    <script src="draft-user-ui.js"></script>
    <script src="draft-user-actions.js"></script>
    <script src="draft.js"></script> <!-- Orchestratore Draft -->
    <script src="mercato.js"></script> 

    <!-- 5. LOGICHE ADMIN (Dipendono da Core, Admin-UI/Players/Teams) -->
    <script src="admin-ui.js"></script>
    <script src="admin-players.js"></script>
    <script src="admin-teams.js"></script>
    <script src="admin-icons.js"></script>
    <script src="admin.js"></script>
    <script src="admin-feature-flags.js"></script>

    <!-- 6. LOGICHE CAMPIONATO (Dipendono da Simulation, Core e Admin) -->
    <script src="campionato-rewards.js"></script>
    <script src="campionato-simulation.js"></script>
    <script src="campionato-schedule.js"></script>
    <script src="campionato-ui.js"></script>
    <script src="campionato-main.js"></script>
    <script src="campionato.js"></script>
    <script src="automazione-simulazioni.js"></script>

    <!-- 7. COPPASERIA (Dipendono da Campionato e Simulation) -->
    <script src="coppa-constants.js"></script>
    <script src="coppa-brackets.js"></script>
    <script src="coppa-simulation.js"></script>
    <script src="coppa-schedule.js"></script>
    <script src="coppa-ui.js"></script>
    <script src="coppa-main.js"></script>

    <!-- 8. SUPERCOPPA (Dipende da Campionato e Coppa) -->
    <script src="supercoppa.js"></script>

    <!-- 9. ORCHESTRATORE FINALE (Avvia l'app) -->
    <script src="interfaccia.js"></script>

    <!-- 10. MATCH REPLAY SYSTEM -->
    <script src="match-replay-simple.js"></script>

    <!-- 11. PLAYER STATS SYSTEM -->
    <script src="player-stats.js"></script>
    <script src="player-stats-ui.js"></script>

    <!-- 12. ABILITIES ENCYCLOPEDIA -->
    <script src="abilities-encyclopedia.js"></script>
    <script src="abilities-encyclopedia-ui.js"></script>
    <script src="rules-panel.js"></script>
    <script src="sponsor-media.js"></script>
    <script src="user-championship.js"></script>
    <script src="user-competitions.js"></script>

    <!-- 13. CREDITI SUPER SERI (Valuta Premium) -->
    <script src="crediti-super-seri.js"></script>
    <script src="crediti-super-seri-ui.js"></script>

    <!-- 14. UNIFORM EDITOR (Editor Divisa Squadra) -->
    <script src="uniform-editor.js"></script>

    <!-- 15. PWA SERVICE WORKER REGISTRATION E GESTIONE AGGIORNAMENTI -->
    <script>
        // Sistema di aggiornamento PWA
        window.PWAUpdater = {
            registration: null,
            newWorker: null,

            // Mostra banner di aggiornamento
            showUpdateBanner: function() {
                // Rimuovi banner esistente se presente
                const existingBanner = document.getElementById('pwa-update-banner');
                if (existingBanner) existingBanner.remove();

                // Crea banner
                const banner = document.createElement('div');
                banner.id = 'pwa-update-banner';
                banner.innerHTML = `
                    <div style="position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
                                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                color: white; padding: 16px 24px; border-radius: 12px;
                                box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000;
                                display: flex; align-items: center; gap: 16px; max-width: 90vw;">
                        <div style="font-size: 28px;">üîÑ</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 14px;">Nuova versione disponibile!</div>
                            <div style="font-size: 12px; opacity: 0.9;">Aggiorna per le ultime novita</div>
                        </div>
                        <button id="pwa-update-btn" style="background: white; color: #059669; border: none;
                                padding: 10px 20px; border-radius: 8px; font-weight: bold;
                                cursor: pointer; font-size: 14px; transition: transform 0.2s;">
                            Aggiorna Ora
                        </button>
                        <button id="pwa-dismiss-btn" style="background: transparent; color: white; border: none;
                                font-size: 20px; cursor: pointer; padding: 4px 8px; opacity: 0.7;">
                            ‚úï
                        </button>
                    </div>
                `;
                document.body.appendChild(banner);

                // Event listeners
                document.getElementById('pwa-update-btn').addEventListener('click', () => {
                    window.PWAUpdater.applyUpdate();
                });
                document.getElementById('pwa-dismiss-btn').addEventListener('click', () => {
                    banner.remove();
                });
            },

            // Applica l'aggiornamento
            applyUpdate: function() {
                if (this.newWorker) {
                    // Invia messaggio al nuovo SW per attivarsi subito
                    this.newWorker.postMessage({ type: 'SKIP_WAITING' });
                }
            },

            // Forza pulizia cache (utile per debug)
            clearCache: function() {
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'CLEAR_CACHE' });
                }
                // Pulisci anche cache dal lato client
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => caches.delete(name));
                    });
                }
                console.log('[PWA] Cache pulita. Ricarica la pagina.');
                location.reload();
            },

            // Controlla manualmente se ci sono aggiornamenti
            checkForUpdates: function() {
                if (this.registration) {
                    this.registration.update()
                        .then(() => console.log('[PWA] Controllo aggiornamenti completato'))
                        .catch(err => console.warn('[PWA] Errore controllo aggiornamenti:', err));
                }
            }
        };

        // Registra il Service Worker per PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('[PWA] Service Worker registrato:', registration.scope);
                        window.PWAUpdater.registration = registration;

                        // Controlla aggiornamenti ogni 60 minuti
                        setInterval(() => {
                            registration.update();
                        }, 60 * 60 * 1000);

                        // Gestione nuovo worker trovato
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('[PWA] Nuova versione in installazione...');

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // C'e' gia' un SW attivo = e' un aggiornamento
                                        console.log('[PWA] Nuova versione pronta!');
                                        window.PWAUpdater.newWorker = newWorker;
                                        window.PWAUpdater.showUpdateBanner();
                                    } else {
                                        // Prima installazione
                                        console.log('[PWA] App installata e pronta per uso offline');
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.warn('[PWA] Registrazione Service Worker fallita:', error);
                    });
            });

            // Ascolta messaggi dal Service Worker
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'SW_ACTIVATED') {
                    console.log('[PWA] Service Worker aggiornato alla versione:', event.data.version);
                    // Ricarica la pagina per usare la nuova versione
                    location.reload();
                }
            });

            // Gestione cambio controller (quando un nuovo SW prende il controllo)
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('[PWA] Nuovo Service Worker attivato, ricarico...');
                location.reload();
            });
        }

        // Mostra bottone aggiornamento solo se installata come PWA
        function setupPWAUpdateButton() {
            const container = document.getElementById('pwa-update-button-container');
            const btn = document.getElementById('btn-check-pwa-update');

            if (!container || !btn) return;

            // Controlla se l'app e' in modalita' standalone (installata come PWA)
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches
                || window.navigator.standalone === true
                || document.referrer.includes('android-app://');

            if (isStandalone) {
                // Mostra il bottone
                container.classList.remove('hidden');
                console.log('[PWA] App installata, bottone aggiornamento visibile');

                // Gestisci click
                btn.addEventListener('click', async () => {
                    btn.disabled = true;
                    btn.innerHTML = '<span>‚è≥</span> Controllo in corso...';

                    try {
                        // Forza controllo aggiornamenti
                        if (window.PWAUpdater && window.PWAUpdater.registration) {
                            await window.PWAUpdater.registration.update();

                            // Aspetta un attimo per vedere se c'e' un nuovo worker
                            setTimeout(() => {
                                if (window.PWAUpdater.newWorker) {
                                    // C'e' un aggiornamento
                                    btn.innerHTML = '<span>‚úÖ</span> Aggiornamento trovato!';
                                    btn.classList.remove('bg-cyan-600', 'hover:bg-cyan-500');
                                    btn.classList.add('bg-green-600', 'hover:bg-green-500');
                                    window.PWAUpdater.showUpdateBanner();
                                } else {
                                    // Nessun aggiornamento
                                    btn.innerHTML = '<span>‚úÖ</span> Sei aggiornato!';
                                    btn.classList.remove('bg-cyan-600', 'hover:bg-cyan-500');
                                    btn.classList.add('bg-gray-600');
                                    setTimeout(() => {
                                        btn.innerHTML = '<span>üîÑ</span> Controlla Aggiornamenti';
                                        btn.classList.remove('bg-gray-600');
                                        btn.classList.add('bg-cyan-600', 'hover:bg-cyan-500');
                                        btn.disabled = false;
                                    }, 3000);
                                }
                            }, 2000);
                        } else {
                            // Fallback: pulisci cache e ricarica
                            window.PWAUpdater?.clearCache();
                        }
                    } catch (error) {
                        console.error('[PWA] Errore controllo aggiornamenti:', error);
                        btn.innerHTML = '<span>‚ùå</span> Errore, riprova';
                        btn.disabled = false;
                        setTimeout(() => {
                            btn.innerHTML = '<span>üîÑ</span> Controlla Aggiornamenti';
                        }, 2000);
                    }
                });
            } else {
                // Non e' una PWA installata, nascondi il bottone
                container.classList.add('hidden');
            }
        }

        // Esegui quando il DOM e' pronto
        document.addEventListener('DOMContentLoaded', setupPWAUpdateButton);
    </script>

</body>
</html><!-- ============================================ -->
<!-- MATCH REPLAY OVERLAY -->
<!-- ============================================ -->

<div id="match-replay-overlay" class="fixed inset-0 bg-black bg-opacity-95 z-50 hidden overflow-y-auto">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        
        <!-- Header con controlli -->
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-white">üé¨ Replay Partita</h2>
            
            <div class="flex gap-3">
                <!-- Velocit√† -->
                <button id="replay-speed-btn" 
                        onclick="window.MatchReplay.changeSpeed()"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Velocit√†: 1x
                </button>
                
                <!-- Chiudi (solo se non in riproduzione) -->
                <button id="replay-skip-btn" 
                        onclick="window.MatchReplay.hide()"
                        class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                    Salta ‚è≠Ô∏è¬è
                </button>
            </div>
        </div>
        
        <!-- Contenuto dinamico replay -->
        <div id="replay-content" class="min-h-[500px] flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-500 mx-auto mb-4"></div>
                <p class="text-white text-lg">Caricamento replay...</p>
            </div>
        </div>
        
    </div>
</div>

<!-- ============================================ -->
<!-- ANIMAZIONI CSS PER REPLAY -->
<!-- ============================================ -->

<style>
/* Fade In */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.animate-fade-in {
    animation: fadeIn 0.5s ease-in-out;
}

/* Slide In */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-100px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.animate-slide-in {
    animation: slideIn 0.4s ease-out;
}

/* Bounce (gi√†¬† in Tailwind ma ridefinito per sicurezza) */
@keyframes bounce {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-10px);
    }
}

.animate-bounce {
    animation: bounce 0.6s infinite;
}

/* Pulse (gi√†¬† in Tailwind ma ridefinito) */
@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.7;
    }
}

.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

/* Rolling Number (per i dadi) */
@keyframes roll {
    0% { transform: rotateY(0deg); }
    100% { transform: rotateY(720deg); }
}

.rolling-number {
    display: inline-block;
    animation: roll 0.5s ease-out;
}
</style>
