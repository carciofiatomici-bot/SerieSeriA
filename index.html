<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <!-- Viewport ottimizzato per iPhone moderni (notch, Dynamic Island) e Android -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">

    <!-- Theme colors per browser mobile -->
    <meta name="theme-color" content="#16a34a" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0d1b2a" media="(prefers-color-scheme: dark)">

    <!-- iOS PWA ottimizzazioni -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Serie SeriA">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Formato telefono e email -->
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">

    <!-- Descrizione e SEO -->
    <meta name="description" content="Gestisci la tua squadra di fantacalcio, partecipa al draft e sfida i tuoi amici!">
    <meta name="application-name" content="Serie SeriA">

    <!-- Microsoft/Windows Phone -->
    <meta name="msapplication-TileColor" content="#16a34a">
    <meta name="msapplication-tap-highlight" content="no">

    <title>Serie SeriA</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icone PWA - Multiple sizes per tutti i dispositivi -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/serie%20sera%20256.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/serie%20sera%20256.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/serie%20sera%20256.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/serie%20sera%20256.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/serie%20sera%20256.png">
    <link rel="apple-touch-icon" sizes="167x167" href="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/serie%20sera%20256.png">

    <!-- Splash screens iOS (iPhone moderni) -->
    <link rel="apple-touch-startup-image" href="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/serie%20sera%20256.png" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/serie%20sera%20256.png" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/serie%20sera%20256.png" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/serie%20sera%20256.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/serie%20sera%20256.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">

    <!-- Preload risorse critiche per performance -->
    <link rel="preload" href="style.css" as="style">
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://raw.githubusercontent.com" crossorigin>
    <link rel="dns-prefetch" href="https://firestore.googleapis.com">
    <link rel="dns-prefetch" href="https://www.googleapis.com">

    <!-- Handler globale errori - mostra homepage in caso di crash JS -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            console.error('Errore JS globale:', msg, url, line);
            // Dopo 3 secondi, se la pagina e' ancora bloccata, mostra la homepage
            setTimeout(function() {
                var loginBox = document.getElementById('login-box');
                if (loginBox && loginBox.classList.contains('hidden-on-load')) {
                    console.warn('[ErrorHandler] Errore JS rilevato, mostro homepage');
                    loginBox.classList.remove('hidden-on-load', 'hidden');
                }
            }, 3000);
            return false; // Permetti al browser di loggare l'errore
        };
    </script>

    <!-- Carica Tailwind CSS dal CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Collega il foglio di stile esterno -->
    <link rel="stylesheet" href="style.css">
    <!-- CARICA FONT AWESOME (per icone tipologie) - async per non bloccare il render -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"></noscript>

    <!-- Font sportivo per nome squadra -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">

    <!-- Stili per nome squadra animato -->
    <style>
        .team-name-fancy {
            font-family: 'Russo One', sans-serif;
            background: linear-gradient(135deg, #22c55e 0%, #10b981 50%, #34d399 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 20px rgba(34, 197, 94, 0.4), 0 0 40px rgba(34, 197, 94, 0.2);
            animation: shimmer 3s ease-in-out infinite;
            filter: drop-shadow(0 0 8px rgba(34, 197, 94, 0.3));
        }
        @keyframes shimmer {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(34, 197, 94, 0.3)) brightness(1); }
            50% { filter: drop-shadow(0 0 15px rgba(34, 197, 94, 0.5)) brightness(1.1); }
        }
    </style>
</head>
<body>

    <!-- ALERT DRAFT ATTIVO - Flottante in alto a sinistra, sempre visibile quando c'√® un draft -->
    <div id="draft-alert-banner" class="hidden"
         style="position: fixed; top: 10px; left: 10px; z-index: 9999; max-width: min(320px, calc(100vw - 20px));">
        <!-- Versione espansa (hidden di default) -->
        <div id="draft-alert-expanded" class="hidden p-3 bg-gradient-to-r from-purple-900 to-indigo-900 rounded-lg border-2 border-purple-500 shadow-2xl">
            <div class="flex items-center gap-3">
                <span class="text-2xl">üéØ</span>
                <div class="flex-1">
                    <p class="text-purple-300 text-xs font-semibold">DRAFT IN CORSO</p>
                    <p class="text-white font-bold text-sm"><span id="draft-alert-team" class="text-yellow-400">--</span></p>
                    <p id="draft-alert-steal-info" class="hidden text-red-300 text-xs font-semibold"></p>
                    <p id="draft-alert-autoassign-info" class="hidden text-orange-300 text-xs font-semibold"></p>
                </div>
                <div class="text-center">
                    <p class="text-purple-300 text-xs">Tempo</p>
                    <p id="draft-alert-countdown" class="text-xl font-bold text-white">--:--</p>
                    <p id="draft-alert-autoassign-countdown" class="hidden text-orange-400 text-xs font-semibold"></p>
                </div>
                <!-- Bottone minimizza -->
                <button id="draft-alert-minimize"
                        onclick="window.InterfacciaDashboard?.toggleDraftAlertMinimized(true)"
                        class="text-purple-300 hover:text-white transition p-1 -mr-1 -mt-6"
                        title="Minimizza">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            <button id="draft-alert-go-btn"
                    class="w-full mt-2 bg-purple-600 hover:bg-purple-500 text-white font-bold py-1.5 px-3 rounded-lg transition text-xs">
                Vai al Draft ‚Üí
            </button>
        </div>
        <!-- Versione minimizzata (solo emoji) - visibile di default -->
        <div id="draft-alert-minimized">
            <button onclick="window.InterfacciaDashboard?.toggleDraftAlertMinimized(false)"
                    class="w-6 h-6 flex items-center justify-center bg-purple-900/90 rounded-full border border-purple-500/50 shadow hover:scale-110 transition text-xs"
                    title="Espandi alert Draft">üéØ<span id="draft-alert-countdown-mini" class="hidden">--:--</span>
            </button>
        </div>
    </div>

    <!-- MATCH ALERT BANNER - Timer prossima partita (Campionato/Coppa) -->
    <div id="match-alert-banner" class="hidden"
         style="position: fixed; top: 10px; right: 10px; z-index: 9998; max-width: 280px;">
        <!-- Versione espansa (hidden di default) -->
        <div id="match-alert-expanded" class="hidden p-3 bg-gradient-to-r from-teal-900 to-cyan-900 rounded-lg border-2 border-teal-500 shadow-2xl">
            <div class="flex items-center gap-3">
                <span class="text-2xl">‚öΩ</span>
                <div class="flex-1">
                    <p id="match-alert-competition" class="text-teal-300 text-xs font-semibold">PROSSIMA PARTITA</p>
                    <p id="match-alert-info" class="text-white font-bold text-sm">--</p>
                    <p id="match-alert-opponent" class="text-teal-200 text-xs">vs --</p>
                </div>
                <div class="text-center">
                    <p class="text-teal-300 text-xs">Tempo</p>
                    <p id="match-alert-countdown" class="text-xl font-bold text-teal-400">--:--:--</p>
                </div>
                <!-- Bottone minimizza -->
                <button id="match-alert-minimize"
                        onclick="window.InterfacciaDashboard?.toggleMatchAlertMinimized(true)"
                        class="text-teal-300 hover:text-white transition p-1 -mr-1 -mt-6"
                        title="Minimizza">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
        </div>
        <!-- Versione minimizzata (solo emoji) - visibile di default -->
        <div id="match-alert-minimized">
            <button onclick="window.InterfacciaDashboard?.toggleMatchAlertMinimized(false)"
                    class="w-6 h-6 flex items-center justify-center bg-teal-900/90 rounded-full border border-teal-500/50 shadow hover:scale-110 transition text-xs"
                    title="Espandi timer partita">‚öΩ<span id="match-alert-countdown-mini" class="hidden">--:--:--</span>
            </button>
        </div>
    </div>

    <!-- PWA INSTALL BANNER - Mostra quando l'app e' installabile -->
    <div id="pwa-install-banner" class="hidden"
         style="position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 9997; width: calc(100% - 32px); max-width: 400px;">
        <div class="bg-gradient-to-r from-green-900 to-emerald-900 rounded-xl border-2 border-green-500 shadow-2xl p-4">
            <div class="flex items-center gap-3">
                <img src="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/serie%20sera%20256.png"
                     alt="Serie SeriA"
                     class="w-12 h-12 rounded-xl"
                     loading="lazy"
                     decoding="async">
                <div class="flex-1">
                    <p class="text-white font-bold text-sm">Installa Serie SeriA</p>
                    <p class="text-green-300 text-xs">Accesso rapido dalla home del tuo dispositivo</p>
                </div>
                <button onclick="window.hideInstallBanner(true)"
                        class="text-green-300 hover:text-white p-1"
                        title="Chiudi (non mostrare per 15 giorni)">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex gap-2 mt-3">
                <button onclick="window.hideInstallBanner(true)"
                        class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition text-sm">
                    Non ora
                </button>
                <button onclick="window.installPWA()"
                        class="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition text-sm flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Installa
                </button>
            </div>
        </div>
    </div>

    <!-- Bottone Regole Globale (nascosto quando dashboard attiva - usa tab invece) -->
    <div id="rules-btn-container" class="hidden-on-dashboard" style="position: fixed; bottom: 20px; right: 20px; z-index: 9998;">
        <!-- Bottone normale (espanso) -->
        <button id="rules-global-btn"
                onclick="window.RulesPanel.toggle()"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                       color: white; font-weight: bold; padding: 12px 20px;
                       border-radius: 50px; border: none; cursor: pointer;
                       box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                       font-size: 16px; display: flex; align-items: center; gap: 8px;
                       transition: all 0.3s ease;">
            <span style="font-size: 20px;">üìñ</span> Regole
            <!-- Bottone minimizza -->
            <span id="rules-minimize-btn"
                  onclick="event.stopPropagation(); window.RulesPanel.minimize();"
                  style="margin-left: 8px; padding: 2px 6px; font-size: 14px;
                         opacity: 0.7; hover: opacity-100;"
                  title="Minimizza">‚úï</span>
        </button>
    </div>

    <!-- Bottone Regole Minimizzato (barra in basso a destra) -->
    <div id="rules-minimized-btn"
         onclick="window.RulesPanel.restore()"
         style="position: fixed; bottom: 20px; right: 0; z-index: 9998;
                background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
                width: 20px; height: 50px;
                border-radius: 4px 0 0 4px;
                cursor: pointer;
                box-shadow: -2px 0 10px rgba(102, 126, 234, 0.5);
                transition: all 0.3s ease;
                display: none;"
         title="Apri Regole">
    </div>

    <!-- Indicatore Versione App (fisso in basso a sinistra) -->
    <div id="app-version-indicator"
         style="position: fixed; bottom: 8px; left: 8px; z-index: 100;
                font-size: 10px; color: rgba(255,255,255,0.3);
                font-family: monospace; pointer-events: none;">
        <span id="app-version-text"></span>
    </div>
    <script>
        // Mostra la versione dell'app
        document.addEventListener('DOMContentLoaded', function() {
            const versionText = document.getElementById('app-version-text');
            if (versionText && window.VersionCheck) {
                versionText.textContent = 'v' + window.VersionCheck.CURRENT_VERSION;
            }
        });
        // Aggiorna anche quando VersionCheck √® pronto (potrebbe caricarsi dopo)
        setTimeout(function() {
            const versionText = document.getElementById('app-version-text');
            if (versionText && window.VersionCheck && !versionText.textContent) {
                versionText.textContent = 'v' + window.VersionCheck.CURRENT_VERSION;
            }
        }, 2000);
    </script>

    <!-- Pannello Regole (nascosto inizialmente) - z-index molto alto per stare sempre in primo piano -->
    <div id="rules-panel" class="hidden fixed inset-0 bg-black bg-opacity-95 z-[9999] overflow-y-auto">
        <div class="container mx-auto px-4 py-8 max-w-4xl">
            <!-- Header -->
            <div class="bg-gradient-to-r from-purple-900 to-indigo-900 rounded-t-lg p-6 border-b-4 border-yellow-500">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-4xl font-bold text-white mb-2">üìñ Regole del Gioco</h1>
                        <p class="text-gray-300">Serie SeriA - Fantacalcio Serio</p>
                    </div>
                    <button onclick="window.RulesPanel.close()"
                            class="text-white hover:text-red-400 text-4xl font-bold">
                        X
                    </button>
                </div>
            </div>

            <!-- Contenuto Regole -->
            <div class="bg-gray-800 p-6 space-y-4">

                <!-- Sezione Squadra (Accordion) -->
                <div class="bg-gray-900 rounded-lg border border-yellow-500">
                    <button onclick="window.RulesPanel.toggleSection('squadra')"
                            class="w-full p-4 flex justify-between items-center text-left hover:bg-gray-800 rounded-lg transition">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">‚öΩ</span>
                            <h3 class="text-xl font-bold text-yellow-400">La Squadra</h3>
                        </div>
                        <span id="arrow-squadra" class="text-yellow-400 text-xl transition-transform duration-300">‚ñ∂</span>
                    </button>
                    <div id="content-squadra" class="hidden p-4 border-t border-yellow-700">
                        <ul class="text-gray-300 space-y-2 text-sm">
                            <li>‚Ä¢ Ogni squadra ha <strong class="text-white">15 giocatori + 1 Icona</strong> (capitano speciale)</li>
                            <li>‚Ä¢ <strong class="text-white">Formazione:</strong> 5 titolari in campo + 3 in panchina + riserve</li>
                            <li>‚Ä¢ <strong class="text-white">Moduli disponibili:</strong> 1-2-2, 1-1-2-1, 1-3-1, 1-1-3</li>
                            <li>‚Ä¢ Ruoli: <span class="text-blue-400">P</span> (Portiere), <span class="text-green-400">D</span> (Difensore), <span class="text-yellow-400">C</span> (Centrocampista), <span class="text-red-400">A</span> (Attaccante)</li>
                            <li>‚Ä¢ Tipologie: <span class="text-red-400">Potenza</span> > <span class="text-blue-400">Tecnica</span> > <span class="text-yellow-400">Velocita</span> > <span class="text-red-400">Potenza</span> (carta-forbice-sasso)</li>
                            <li>‚Ä¢ Livelli: 1-30 (ogni 2 livelli aumenta il modificatore di +0.5)</li>
                            <li>‚Ä¢ <strong class="text-yellow-400">Icona:</strong> Capitano speciale con bonus +1 a tutti i modificatori (50% prob. per partita)</li>
                        </ul>
                    </div>
                </div>

                <!-- Sezione Livelli Giocatore (Accordion) -->
                <div class="bg-gray-900 rounded-lg border border-sky-500">
                    <button onclick="window.RulesPanel.toggleSection('livelli')"
                            class="w-full p-4 flex justify-between items-center text-left hover:bg-gray-800 rounded-lg transition">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">üìä</span>
                            <h3 class="text-xl font-bold text-sky-400">Livelli e Modificatori</h3>
                        </div>
                        <span id="arrow-livelli" class="text-sky-400 text-xl transition-transform duration-300">‚ñ∂</span>
                    </button>
                    <div id="content-livelli" class="hidden p-4 border-t border-sky-700">
                        <div class="space-y-4 text-sm">
                            <!-- Spiegazione -->
                            <div class="bg-gray-800 rounded-lg p-3 border-l-4 border-sky-500">
                                <p class="text-gray-300 mb-2">Il <strong class="text-sky-400">Livello</strong> di un giocatore determina il suo <strong class="text-white">Modificatore</strong>, un bonus numerico che viene aggiunto ai tiri durante le fasi di gioco.</p>
                                <p class="text-gray-400 text-xs">Piu alto il livello = piu forte il giocatore nelle simulazioni.</p>
                            </div>

                            <!-- Tabella Modificatori -->
                            <div class="bg-black bg-opacity-30 rounded-lg p-3">
                                <h4 class="font-bold text-sky-400 mb-3 text-center">Tabella Modificatori per Livello (v4.0)</h4>
                                <div class="grid grid-cols-3 gap-x-4 gap-y-1 text-xs">
                                    <!-- Colonna 1: Liv 1-10 -->
                                    <div class="space-y-1">
                                        <div class="flex justify-between"><span class="text-gray-400">Liv 1-2</span><span class="text-white font-mono">0.5</span></div>
                                        <div class="flex justify-between"><span class="text-gray-400">Liv 3-4</span><span class="text-white font-mono">1.0</span></div>
                                        <div class="flex justify-between"><span class="text-gray-400">Liv 5-6</span><span class="text-white font-mono">1.5</span></div>
                                        <div class="flex justify-between"><span class="text-gray-400">Liv 7-8</span><span class="text-white font-mono">2.0</span></div>
                                        <div class="flex justify-between"><span class="text-gray-400">Liv 9-10</span><span class="text-white font-mono">2.5</span></div>
                                    </div>
                                    <!-- Colonna 2: Liv 11-20 -->
                                    <div class="space-y-1">
                                        <div class="flex justify-between"><span class="text-gray-400">Liv 11-12</span><span class="text-white font-mono">3.0</span></div>
                                        <div class="flex justify-between"><span class="text-gray-400">Liv 13-14</span><span class="text-white font-mono">3.5</span></div>
                                        <div class="flex justify-between"><span class="text-gray-400">Liv 15-16</span><span class="text-white font-mono">4.0</span></div>
                                        <div class="flex justify-between"><span class="text-gray-400">Liv 17-18</span><span class="text-white font-mono">4.5</span></div>
                                        <div class="flex justify-between"><span class="text-gray-400">Liv 19-20</span><span class="text-white font-mono">5.0</span></div>
                                    </div>
                                    <!-- Colonna 3: Liv 21-30 -->
                                    <div class="space-y-1">
                                        <div class="flex justify-between"><span class="text-gray-400">Liv 21-22</span><span class="text-white font-mono">5.5</span></div>
                                        <div class="flex justify-between"><span class="text-gray-400">Liv 23-24</span><span class="text-white font-mono">6.0</span></div>
                                        <div class="flex justify-between"><span class="text-gray-400">Liv 25-26</span><span class="text-white font-mono">6.5</span></div>
                                        <div class="flex justify-between"><span class="text-gray-400">Liv 27-28</span><span class="text-white font-mono">7.0</span></div>
                                        <div class="flex justify-between"><span class="text-yellow-400">Liv 29</span><span class="text-yellow-400 font-mono">8.0</span></div>
                                        <div class="flex justify-between"><span class="text-yellow-400">Liv 30</span><span class="text-yellow-400 font-mono">9.0</span></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Note -->
                            <div class="bg-yellow-900 bg-opacity-20 rounded p-2 border border-yellow-700">
                                <p class="text-yellow-300 text-xs">I livelli 29 e 30 hanno modificatori piu alti della media, premiando i giocatori al massimo!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sezione Limiti di Crescita (Accordion) -->
                <div class="bg-gray-900 rounded-lg border border-emerald-500">
                    <button onclick="window.RulesPanel.toggleSection('crescita')"
                            class="w-full p-4 flex justify-between items-center text-left hover:bg-gray-800 rounded-lg transition">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">üå±</span>
                            <h3 class="text-xl font-bold text-emerald-400">Limiti di Crescita</h3>
                        </div>
                        <span id="arrow-crescita" class="text-emerald-400 text-xl transition-transform duration-300">‚ñ∂</span>
                    </button>
                    <div id="content-crescita" class="hidden p-4 border-t border-emerald-700">
                        <div class="space-y-3 text-sm">
                            <div class="bg-gray-800 rounded-lg p-3 border-l-4 border-emerald-500">
                                <p class="text-gray-300 mb-2">Ogni giocatore ha un <strong class="text-emerald-400">livello massimo segreto</strong> che rappresenta il suo potenziale di crescita.</p>
                                <ul class="text-gray-300 space-y-1 text-xs">
                                    <li>‚Ä¢ Il potenziale e determinato casualmente alla creazione del giocatore</li>
                                    <li>‚Ä¢ Non puoi vedere il potenziale finche non lo raggiungi</li>
                                    <li>‚Ä¢ Alcuni giocatori sono talenti naturali, altri hanno margini di crescita limitati</li>
                                </ul>
                            </div>
                            <div class="bg-emerald-900 bg-opacity-20 rounded p-2 border border-emerald-700">
                                <p class="text-emerald-300 text-xs"><strong>Upgrade:</strong> Quando un giocatore raggiunge il suo limite, puoi usare i <span class="text-amber-400">CSS</span> per aumentare il suo potenziale. Questo ti permette di continuare a farlo crescere!</p>
                            </div>
                            <div class="bg-yellow-900 bg-opacity-20 rounded p-2 border border-yellow-700">
                                <p class="text-yellow-300 text-xs"><strong>Consiglio:</strong> Investi nei giocatori con abilita rare - anche con potenziale basso, possono diventare campioni con gli upgrade!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sezione Partita (Accordion) -->
                <div class="bg-gray-900 rounded-lg border border-green-500">
                    <button onclick="window.RulesPanel.toggleSection('partita')"
                            class="w-full p-4 flex justify-between items-center text-left hover:bg-gray-800 rounded-lg transition">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">üéÆ</span>
                            <h3 class="text-xl font-bold text-green-400">La Partita</h3>
                        </div>
                        <span id="arrow-partita" class="text-green-400 text-xl transition-transform duration-300">‚ñ∂</span>
                    </button>
                    <div id="content-partita" class="hidden p-4 border-t border-green-700">
                        <ul class="text-gray-300 space-y-2 text-sm">
                            <li>‚Ä¢ <strong class="text-white">50 occasioni totali</strong> per partita (25 per squadra, alternate)</li>
                            <li>‚Ä¢ Ogni occasione ha 3 fasi: <strong class="text-cyan-400">Costruzione</strong> ‚Üí <strong class="text-orange-400">Attacco</strong> ‚Üí <strong class="text-red-400">Tiro</strong></li>
                            <li>‚Ä¢ <strong class="text-cyan-400">Costruzione:</strong> Centrocampisti + Difensori cercano di conquistare il possesso</li>
                            <li>‚Ä¢ <strong class="text-orange-400">Attacco:</strong> Attaccanti + Centrocampisti vs Difensori avversari</li>
                            <li>‚Ä¢ <strong class="text-red-400">Tiro:</strong> Se le fasi precedenti hanno successo, tiro vs Portiere</li>
                            <li>‚Ä¢ Le abilita si attivano automaticamente durante le fasi appropriate</li>
                            <li>‚Ä¢ La <strong class="text-white">forma fisica</strong> modifica il livello effettivo dei giocatori (vedi sezione Forma)</li>
                        </ul>
                    </div>
                </div>

                <!-- Sezione Sistema Forma (Accordion) - NUOVO -->
                <div class="bg-gray-900 rounded-lg border border-orange-500">
                    <button onclick="window.RulesPanel.toggleSection('forma')"
                            class="w-full p-4 flex justify-between items-center text-left hover:bg-gray-800 rounded-lg transition">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">üí™</span>
                            <h3 class="text-xl font-bold text-orange-400">Sistema Forma</h3>
                        </div>
                        <span id="arrow-forma" class="text-orange-400 text-xl transition-transform duration-300">‚ñ∂</span>
                    </button>
                    <div id="content-forma" class="hidden p-4 border-t border-orange-700">
                        <div class="space-y-4 text-sm">

                            <!-- Introduzione -->
                            <div class="bg-gray-800 rounded-lg p-3 border-l-4 border-orange-500">
                                <p class="text-gray-300 mb-2">La <strong class="text-orange-400">Forma</strong> rappresenta lo stato fisico/mentale di un giocatore. Modifica temporaneamente il suo livello effettivo durante le partite.</p>
                                <p class="text-gray-400 text-xs">Range: <strong class="text-white">-3</strong> (pessima) a <strong class="text-white">+3</strong> (eccellente) per tutti i giocatori.</p>
                            </div>

                            <!-- Inizio Stagione -->
                            <div class="bg-black bg-opacity-30 rounded p-3">
                                <p class="text-cyan-400 font-bold text-xs mb-2">INIZIO STAGIONE</p>
                                <p class="text-gray-300 text-xs">Tutti i giocatori partono con forma <strong class="text-white">0</strong> (neutra).</p>
                            </div>

                            <!-- Bonus Prestazioni -->
                            <div class="bg-black bg-opacity-30 rounded p-3">
                                <p class="text-green-400 font-bold text-xs mb-2">BONUS PRESTAZIONI (dopo ogni partita)</p>
                                <div class="grid grid-cols-1 gap-1 text-xs">
                                    <div class="flex justify-between items-center bg-green-900 bg-opacity-30 rounded px-2 py-1">
                                        <span class="text-gray-300">Gol segnato</span>
                                        <span class="text-green-400 font-bold">+1</span>
                                    </div>
                                    <div class="flex justify-between items-center bg-green-900 bg-opacity-30 rounded px-2 py-1">
                                        <span class="text-gray-300">Assist</span>
                                        <span class="text-green-400 font-bold">+1</span>
                                    </div>
                                    <div class="flex justify-between items-center bg-green-900 bg-opacity-30 rounded px-2 py-1">
                                        <span class="text-gray-300">Clean sheet (portiere)</span>
                                        <span class="text-green-400 font-bold">+1</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Panchina Consecutiva -->
                            <div class="bg-black bg-opacity-30 rounded p-3">
                                <p class="text-red-400 font-bold text-xs mb-2">PANCHINA CONSECUTIVA</p>
                                <p class="text-gray-400 text-xs mb-2">Giocatori non schierati per piu partite consecutive rischiano di perdere forma:</p>
                                <div class="grid grid-cols-1 gap-1 text-xs">
                                    <div class="flex justify-between items-center bg-red-900 bg-opacity-30 rounded px-2 py-1">
                                        <span class="text-gray-300">1 partita in panchina</span>
                                        <span class="text-yellow-400">10% chance <span class="text-red-400">-1</span></span>
                                    </div>
                                    <div class="flex justify-between items-center bg-red-900 bg-opacity-30 rounded px-2 py-1">
                                        <span class="text-gray-300">2 partite consecutive</span>
                                        <span class="text-yellow-400">20% chance <span class="text-red-400">-1</span></span>
                                    </div>
                                    <div class="flex justify-between items-center bg-red-900 bg-opacity-30 rounded px-2 py-1">
                                        <span class="text-gray-300">3+ partite consecutive</span>
                                        <span class="text-yellow-400">30% chance <span class="text-red-400">-1</span></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Elemento Random -->
                            <div class="bg-black bg-opacity-30 rounded p-3">
                                <p class="text-purple-400 font-bold text-xs mb-2">ELEMENTO CASUALE</p>
                                <div class="grid grid-cols-1 gap-1 text-xs">
                                    <div class="flex justify-between items-center bg-purple-900 bg-opacity-30 rounded px-2 py-1">
                                        <span class="text-gray-300">Titolari (dopo partita)</span>
                                        <span class="text-purple-400">20% chance <span class="text-white">¬±1</span></span>
                                    </div>
                                    <div class="flex justify-between items-center bg-purple-900 bg-opacity-30 rounded px-2 py-1">
                                        <span class="text-gray-300">Tutti i giocatori</span>
                                        <span class="text-purple-400">10% chance <span class="text-white">¬±1</span></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Note -->
                            <div class="bg-orange-900 bg-opacity-20 rounded p-2 border border-orange-700">
                                <p class="text-orange-300 text-xs"><strong>Cura Forma:</strong> Puoi usare gli oggetti "Cura Forma" per riportare un giocatore a forma 0.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sezione Simulazione (Accordion) - DETTAGLIATA -->
                <div class="bg-gray-900 rounded-lg border border-cyan-500">
                    <button onclick="window.RulesPanel.toggleSection('simulazione')"
                            class="w-full p-4 flex justify-between items-center text-left hover:bg-gray-800 rounded-lg transition">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">‚öôÔ∏è</span>
                            <h3 class="text-xl font-bold text-cyan-400">Regolamento Simulazione</h3>
                        </div>
                        <span id="arrow-simulazione" class="text-cyan-400 text-xl transition-transform duration-300">‚ñ∂</span>
                    </button>
                    <div id="content-simulazione" class="hidden p-4 border-t border-cyan-700">
                        <div class="space-y-4 text-sm">

                            <!-- Preparazione -->
                            <div class="bg-gray-800 rounded-lg p-3 border-l-4 border-blue-500">
                                <h4 class="font-bold text-blue-400 mb-2">1. Preparazione</h4>
                                <ul class="text-gray-300 space-y-1">
                                    <li>‚Ä¢ <strong>Schieramento</strong>: Conferma la formazione con titolari e panchina</li>
                                    <li>‚Ä¢ <strong>Forma Fisica</strong>: Range da -3 a +3 per tutti (inizio stagione: forma 0)</li>
                                    <li>‚Ä¢ <strong>Abilita</strong>: Vengono considerate le abilita di campo e panchina</li>
                                </ul>
                            </div>

                            <!-- Modificatori -->
                            <div class="bg-gray-800 rounded-lg p-3 border-l-4 border-green-500">
                                <h4 class="font-bold text-green-400 mb-2">2. Modificatori Tattici (v4.0)</h4>
                                <ul class="text-gray-300 space-y-1">
                                    <li>‚Ä¢ <strong>Tipologia (Sasso-Carta-Forbice)</strong>:</li>
                                    <li class="ml-4 text-xs"><span class="text-red-400">Potenza</span> > <span class="text-blue-400">Tecnica</span> > <span class="text-yellow-400">Velocita</span> > <span class="text-red-400">Potenza</span></li>
                                    <li class="ml-4 text-xs text-green-400">Chi vince: <strong>+1.5</strong> al modificatore</li>
                                    <li class="ml-4 text-xs text-red-400">Chi perde: <strong>-1.5</strong> al modificatore</li>
                                    <li>‚Ä¢ <strong>Bonus Allenatore</strong>: +(1/2 Livello Allenatore) in tutte le fasi</li>
                                    <li>‚Ä¢ <strong>Bonus Capitano</strong>: Il capitano ha sempre +1 ai modificatori</li>
                                </ul>
                            </div>

                            <!-- Le 3 Fasi -->
                            <div class="bg-gray-800 rounded-lg p-3 border-l-4 border-yellow-500">
                                <h4 class="font-bold text-yellow-400 mb-2">3. Le 3 Fasi (50 occasioni per partita)</h4>
                                <p class="text-gray-400 text-xs mb-3">Ogni occasione passa attraverso 3 fasi. Se una fase fallisce, l'occasione termina senza goal (5% chance di passare comunque).</p>

                                <div class="bg-black bg-opacity-30 rounded p-2 mb-2">
                                    <p class="text-cyan-400 font-bold text-xs mb-1">FASE 1: COSTRUZIONE</p>
                                    <p class="text-gray-400 text-xs">La squadra attaccante cerca di superare il centrocampo avversario</p>
                                    <p class="text-gray-300 text-xs">Attaccanti: [1d20 + Mod.Dif + Mod.Cen + All/2]</p>
                                    <p class="text-gray-300 text-xs">Difensori: [1d20 + Mod.Cen + All/2]</p>
                                    <p class="text-gray-400 text-xs mt-1">Successo = 50% +/- differenza (min 5%, max 95%)</p>
                                </div>

                                <div class="bg-black bg-opacity-30 rounded p-2 mb-2">
                                    <p class="text-orange-400 font-bold text-xs mb-1">FASE 2: ATTACCO vs DIFESA</p>
                                    <p class="text-gray-400 text-xs">L'attacco cerca di superare la difesa avversaria</p>
                                    <p class="text-gray-300 text-xs">Attaccanti: [1d20 + Mod.Cen + Mod.Att + All/2]</p>
                                    <p class="text-gray-300 text-xs">Difensori: [1d20 + Mod.Dif + Mod.Cen + All/2]</p>
                                    <p class="text-gray-400 text-xs mt-1">Risultato >= 0: Successo! Il valore diventa il "Valore Tiro"</p>
                                </div>

                                <div class="bg-black bg-opacity-30 rounded p-2">
                                    <p class="text-red-400 font-bold text-xs mb-1">FASE 3: TIRO vs PORTIERE</p>
                                    <p class="text-gray-400 text-xs">Il tiro viene effettuato contro il portiere</p>
                                    <p class="text-gray-300 text-xs">Calcolo: [1d20 + Mod.Portiere] - [1d10 + Valore Tiro]</p>
                                    <p class="text-green-400 text-xs mt-1">Risultato > 0: Parata</p>
                                    <p class="text-yellow-400 text-xs">Risultato = 0: 50/50 (si tira un dado)</p>
                                    <p class="text-red-400 text-xs">Risultato < 0: GOAL!</p>
                                </div>
                            </div>

                            <!-- Post Partita -->
                            <div class="bg-gray-800 rounded-lg p-3 border-l-4 border-purple-500">
                                <h4 class="font-bold text-purple-400 mb-2">4. Post-Partita</h4>
                                <ul class="text-gray-300 space-y-1">
                                    <li>‚Ä¢ <strong>Classifica</strong>: Aggiornata automaticamente</li>
                                    <li>‚Ä¢ <strong>Infortuni</strong>: 1% probabilita per giocatore (max 1 per squadra)</li>
                                    <li>‚Ä¢ <strong>Forma</strong>: Aggiornata in base a prestazioni (gol, assist, clean sheet)</li>
                                    <li>‚Ä¢ <strong>Premi</strong>: CS distribuiti in base al risultato</li>
                                </ul>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Sezione Valute (Accordion) -->
                <div class="bg-gray-900 rounded-lg border border-amber-500">
                    <button onclick="window.RulesPanel.toggleSection('valute')"
                            class="w-full p-4 flex justify-between items-center text-left hover:bg-gray-800 rounded-lg transition">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">üí∞</span>
                            <h3 class="text-xl font-bold text-amber-400">Valute</h3>
                        </div>
                        <span id="arrow-valute" class="text-amber-400 text-xl transition-transform duration-300">‚ñ∂</span>
                    </button>
                    <div id="content-valute" class="hidden p-4 border-t border-amber-700">
                        <ul class="text-gray-300 space-y-2 text-sm">
                            <li>‚Ä¢ <strong class="text-white">CS (Crediti Seri)</strong>: Valuta standard per acquistare giocatori</li>
                            <li>‚Ä¢ <strong class="text-amber-400">CSS (Crediti Super Seri)</strong>: Valuta premium per potenziamenti e abilita</li>
                            <li>‚Ä¢ Si guadagnano CS vincendo partite e completando la stagione</li>
                            <li>‚Ä¢ Si guadagnano CSS vincendo trofei (Campionato, Coppa, Supercoppa)</li>
                        </ul>
                    </div>
                </div>

                <!-- Sezione Competizioni (Accordion) -->
                <div class="bg-gray-900 rounded-lg border border-purple-500">
                    <button onclick="window.RulesPanel.toggleSection('competizioni')"
                            class="w-full p-4 flex justify-between items-center text-left hover:bg-gray-800 rounded-lg transition">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">üèÜ</span>
                            <h3 class="text-xl font-bold text-purple-400">Competizioni</h3>
                        </div>
                        <span id="arrow-competizioni" class="text-purple-400 text-xl transition-transform duration-300">‚ñ∂</span>
                    </button>
                    <div id="content-competizioni" class="hidden p-4 border-t border-purple-700">
                        <ul class="text-gray-300 space-y-2 text-sm">
                            <li>‚Ä¢ <strong class="text-green-400">SerieSeriA</strong>: Campionato a girone unico, tutti contro tutti</li>
                            <li>‚Ä¢ <strong class="text-purple-400">CoppaSeriA</strong>: Eliminazione diretta con andata e ritorno</li>
                            <li>‚Ä¢ <strong class="text-yellow-400">Supercoppa</strong>: Partita secca tra Campione e Vincitore Coppa</li>
                        </ul>
                    </div>
                </div>

                <!-- Sezione Enciclopedia Abilita (Accordion) -->
                <div class="bg-gray-900 rounded-lg border border-pink-500">
                    <button id="btn-toggle-encyclopedia"
                            onclick="window.RulesPanel.toggleEncyclopedia()"
                            class="w-full p-4 flex justify-between items-center text-left hover:bg-gray-800 rounded-lg transition">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">üìî</span>
                            <h3 class="text-xl font-bold text-pink-400">Enciclopedia Abilita</h3>
                        </div>
                        <span id="encyclopedia-arrow" class="text-pink-400 text-xl transition-transform duration-300">‚ñ∂</span>
                    </button>
                    <div id="encyclopedia-content" class="hidden p-4 border-t border-pink-700">
                        <div id="encyclopedia-container">
                            <!-- Contenuto enciclopedia caricato dinamicamente -->
                            <p class="text-gray-400 text-center">Caricamento abilita...</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Footer -->
            <div class="bg-gray-900 p-4 rounded-b-lg">
                <button onclick="window.RulesPanel.close()"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-lg">
                    Chiudi Regole
                </button>
            </div>
        </div>
    </div>

    <main class="min-h-screen p-4 flex flex-col items-center" id="main-content">

        <!-- 1. BOX GATE - RIMOSSO (accesso diretto al login) -->
        <!-- Il gate con password √® stato rimosso per sicurezza -->
        <div id="gate-box" class="hidden" style="display: none !important;">
            <!-- Gate rimosso - gli utenti vanno direttamente al login -->
        </div>

        <!-- 2. BOX LOGIN (Nome Squadra / Password) -->
        <div id="login-box" class="w-full min-h-screen transition duration-500 hidden-on-load relative overflow-visible pb-20 px-2 sm:px-4">

            <!-- Header con Logo Serie SeriA (mostrato quando non loggato) -->
            <div id="login-header" class="mb-3">
                <div id="login-title-box" class="rounded-lg border border-green-500/50 p-3 text-center">
                    <div class="flex items-center justify-center gap-3 mb-2">
                        <img src="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/serie%20sera%20256.png"
                             alt="Serie SeriA Logo"
                             class="w-16 h-16 sm:w-20 sm:h-20 object-contain">
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-400 via-green-500 to-green-600">
                        SERIE SERIA
                    </h1>
                    <p class="text-xs text-gray-400 mt-1">Fantasy Football Manager</p>
                </div>
            </div>

            <!-- Header Team Name (mostrato quando loggato - il team-name-box viene spostato qui dal JS) -->
            <div id="home-team-header" class="hidden mb-1">
                <!-- Il team-name-box viene spostato qui dinamicamente quando l'utente e' sulla homepage -->
            </div>

            <!-- SEZIONE SESSIONE RICORDATA (nascosta di default) -->
            <div id="remembered-session-box" class="hidden mb-3">
                <div id="remembered-box" class="rounded-lg border border-green-500/50 p-4 text-center">
                    <img id="remembered-team-logo" src="" alt="Logo Squadra" class="w-20 h-20 rounded-full mx-auto mb-3 border-4 border-green-400 object-cover">
                    <p class="text-lg font-bold text-white mb-1" id="remembered-team-name">Nome Squadra</p>
                    <p class="text-xs text-gray-400 mb-4">Sessione attiva</p>
                    <button id="btn-reenter-dashboard"
                            class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white font-extrabold py-3 rounded-lg shadow-xl hover:from-green-500 hover:to-green-600 transition duration-150 transform hover:scale-[1.02] mb-2">
                        üè† Rientra in Dashboard
                    </button>
                    <button id="btn-full-logout"
                            class="w-full bg-gradient-to-r from-red-600 to-red-700 text-white font-semibold py-2 rounded-lg shadow-md hover:from-red-500 hover:to-red-600 transition duration-150">
                        üö™ Logout Completo
                    </button>
                </div>
            </div>

            <!-- BOX 1: LOGIN -->
            <div id="normal-login-box" class="rounded-lg border border-green-500/50 p-4 mb-3">
                <h3 class="text-sm font-bold text-green-400 mb-3 text-center flex items-center justify-center gap-2">
                    <span>üîê</span> Accedi alla tua Squadra
                </h3>
                <input type="text" id="login-username" placeholder="Nome Squadra"
                       class="w-full p-3 border border-gray-600 rounded-lg focus:ring-green-400 focus:border-green-400 bg-gray-800/50 text-white mb-3">
                <input type="password" id="login-password" placeholder="Password"
                       class="w-full p-3 border border-gray-600 rounded-lg focus:ring-green-400 focus:border-green-400 bg-gray-800/50 text-white mb-3">
                <button id="login-button"
                        class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white font-extrabold py-3 rounded-lg shadow-xl hover:from-green-500 hover:to-green-600 transition duration-150 transform hover:scale-[1.02]">
                    Accedi / Crea Squadra
                </button>
                <p id="login-message" class="text-center mt-2 text-red-400 text-sm"></p>
            </div>

            <!-- BOX 2: ESPLORA LEGA -->
            <div id="explore-box" class="rounded-lg border p-4 mb-3" style="border-color: var(--team-primary-color, rgba(34, 197, 94, 0.5))">
                <h3 class="text-sm font-bold text-green-400 mb-3 text-center flex items-center justify-center gap-2">
                    <span>üåê</span> Esplora la Lega
                </h3>
                <div class="grid grid-cols-3 gap-2">
                    <button id="btn-leaderboard"
                            class="bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold py-2 rounded-lg shadow-md hover:from-blue-500 hover:to-blue-600 transition duration-150 transform hover:scale-[1.02] text-xs">
                        üìä Classifica
                    </button>
                    <button id="btn-schedule"
                            class="bg-gradient-to-r from-teal-600 to-teal-700 text-white font-semibold py-2 rounded-lg shadow-md hover:from-teal-500 hover:to-teal-600 transition duration-150 transform hover:scale-[1.02] text-xs">
                        üìÖ Calendario
                    </button>
                    <button id="btn-coppa-home"
                            class="bg-gradient-to-r from-purple-600 to-purple-700 text-white font-semibold py-2 rounded-lg shadow-md hover:from-purple-500 hover:to-purple-600 transition duration-150 transform hover:scale-[1.02] text-xs">
                        üèÜ Coppa
                    </button>
                    <button id="btn-supercoppa-home"
                            class="bg-gradient-to-r from-amber-600 to-amber-700 text-white font-semibold py-2 rounded-lg shadow-md hover:from-amber-500 hover:to-amber-600 transition duration-150 transform hover:scale-[1.02] text-xs">
                        ‚≠ê SuperCoppa
                    </button>
                    <button id="btn-lista-icone"
                            class="bg-gradient-to-r from-yellow-600 to-yellow-700 text-white font-semibold py-2 rounded-lg shadow-md hover:from-yellow-500 hover:to-yellow-600 transition duration-150 transform hover:scale-[1.02] text-xs">
                        üëë Icone
                    </button>
                    <button id="btn-lista-squadre"
                            class="bg-gradient-to-r from-green-600 to-green-700 text-white font-semibold py-2 rounded-lg shadow-md hover:from-green-500 hover:to-green-600 transition duration-150 transform hover:scale-[1.02] text-xs">
                        üìã Squadre
                    </button>
                </div>
            </div>

            <!-- BOX: TABELLA PREMI -->
            <div id="rewards-box" class="rounded-lg border p-3 mb-3 bg-gray-900" style="border-color: var(--team-primary-color, rgba(34, 197, 94, 0.5))">
                <h3 class="text-sm font-bold text-green-400 mb-3 text-center flex items-center justify-center gap-2">
                    <span>üèÜ</span> Premi Stagionali
                </h3>
                <!-- Griglia 3 colonne per competizioni -->
                <div class="grid grid-cols-3 gap-2 text-[10px]">
                    <!-- Campionato -->
                    <div class="bg-gradient-to-b from-green-900/30 to-green-950/30 rounded-lg p-2 border border-green-600/30">
                        <div class="text-center mb-2">
                            <span class="text-xl">üèÖ</span>
                            <p class="text-green-400 font-bold text-xs">SerieSeriA</p>
                        </div>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center bg-black/30 rounded px-1.5 py-0.5">
                                <span class="text-gray-400">ü•á</span>
                                <span id="reward-camp-css" class="text-yellow-300 font-bold">1 CSS</span>
                            </div>
                            <div class="flex justify-between items-center px-1.5">
                                <span class="text-gray-400">Win</span>
                                <span id="reward-camp-win" class="text-green-400">25 CS</span>
                            </div>
                            <div class="flex justify-between items-center px-1.5">
                                <span class="text-gray-400">Goal</span>
                                <span id="reward-camp-goal" class="text-green-400">5 CS</span>
                            </div>
                            <div class="flex justify-between items-center px-1.5">
                                <span class="text-gray-400">Top 3</span>
                                <span id="reward-camp-top3" class="text-green-400">150 CS</span>
                            </div>
                            <div class="flex justify-between items-center px-1.5">
                                <span class="text-gray-400">Last 3</span>
                                <span id="reward-camp-last3" class="text-green-400">200 CS</span>
                            </div>
                        </div>
                    </div>
                    <!-- CoppaSeriA -->
                    <div class="bg-gradient-to-b from-purple-900/30 to-purple-950/30 rounded-lg p-2 border border-purple-600/30">
                        <div class="text-center mb-2">
                            <span class="text-xl">üèÜ</span>
                            <p class="text-purple-400 font-bold text-xs">Coppa</p>
                        </div>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center bg-black/30 rounded px-1.5 py-0.5">
                                <span class="text-gray-400">ü•á</span>
                                <span id="reward-coppa-css" class="text-yellow-300 font-bold">1 CSS</span>
                            </div>
                            <div class="flex justify-between items-center px-1.5">
                                <span class="text-gray-400">Win</span>
                                <span id="reward-coppa-win" class="text-green-400">25 CS</span>
                            </div>
                            <div class="flex justify-between items-center px-1.5">
                                <span class="text-gray-400">Goal</span>
                                <span id="reward-coppa-goal" class="text-green-400">5 CS</span>
                            </div>
                            <div class="flex justify-between items-center px-1.5">
                                <span class="text-gray-400">2-4¬∞</span>
                                <span id="reward-coppa-234" class="text-green-400">100 CS</span>
                            </div>
                        </div>
                    </div>
                    <!-- Supercoppa -->
                    <div class="bg-gradient-to-b from-orange-900/30 to-orange-950/30 rounded-lg p-2 border border-orange-600/30">
                        <div class="text-center mb-2">
                            <span class="text-xl">‚≠ê</span>
                            <p class="text-orange-400 font-bold text-xs">Super</p>
                        </div>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center bg-black/30 rounded px-1.5 py-0.5">
                                <span class="text-gray-400">ü•á</span>
                                <span id="reward-super-css" class="text-yellow-300 font-bold">1 CSS</span>
                            </div>
                            <p class="text-[8px] text-gray-500 text-center mt-2 leading-tight">1¬∞ Camp. vs Vincitore Coppa</p>
                        </div>
                    </div>
                </div>
                <!-- Legenda -->
                <div class="mt-2 pt-2 border-t border-gray-700/50 flex justify-center gap-4 text-[9px] text-gray-400">
                    <span><span class="text-yellow-300">CSS</span> = Crediti Super Seri</span>
                    <span><span class="text-green-400">CS</span> = Crediti Seri</span>
                </div>
            </div>

            <!-- BOX 3: SUPPORTO -->
            <div id="support-box" class="rounded-lg border p-4" style="border-color: var(--team-primary-color, rgba(34, 197, 94, 0.5))">
                <h3 class="text-sm font-bold text-green-400 mb-3 text-center flex items-center justify-center gap-2">
                    <span>üí°</span> Supporto
                </h3>
                <div class="grid grid-cols-2 gap-2">
                    <a href="https://docs.google.com/forms/d/1Iz3CJrVfeNrzR_rU5kmIC-WNCGbDo91yuM5i94P6fnY/edit"
                       target="_blank"
                       class="bg-gradient-to-r from-red-600 to-red-700 text-white font-semibold py-2 rounded-lg shadow-md hover:from-red-500 hover:to-red-600 transition duration-150 transform hover:scale-[1.02] text-center text-xs flex items-center justify-center">
                        üêõ Segnala Bug
                    </a>
                    <button id="btn-home-logout"
                            class="bg-gradient-to-r from-gray-600 to-gray-700 text-white font-semibold py-2 rounded-lg shadow-md hover:from-gray-500 hover:to-gray-600 transition duration-150 transform hover:scale-[1.02] text-center text-xs flex items-center justify-center">
                        üö™ Esci
                    </button>
                </div>
                <div class="mt-3 flex justify-center">
                    <button id="btn-show-changelog"
                            onclick="window.Changelog?.showPlayers()"
                            class="bg-gradient-to-r from-indigo-600 to-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:from-indigo-500 hover:to-indigo-600 transition duration-150 transform hover:scale-[1.02] text-xs flex items-center justify-center gap-2">
                        <span>üìã</span> Novita <span class="bg-indigo-800 px-2 py-0.5 rounded-full text-[10px]">v2.2</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 3. CONTENUTO PRINCIPALE DELL'APP - Dashboard Squadra con 4 Tab -->
        <div id="app-content" class="w-full min-h-screen transition duration-500 hidden-on-load relative overflow-visible pb-20 px-2 sm:px-4">

            <!-- ========== HEADER FISSO (sempre visibile) ========== -->
            <div id="dashboard-fixed-header">
                <!-- Box unificato: Nome Squadra + Risorse -->
                <div id="team-name-box" class="rounded-lg border border-green-500/50 relative">
                    <!-- Nome Squadra (centro) -->
                    <h2 id="team-dashboard-title" class="text-lg sm:text-2xl md:text-3xl font-extrabold text-center uppercase team-name-fancy leading-none py-1">NOME SQUADRA</h2>
                    <!-- Menu Hamburger (sinistra assoluto, allineato al titolo) -->
                    <div class="absolute left-1 top-1">
                        <button id="dashboard-menu-btn" class="w-5 h-5 flex items-center justify-center cursor-pointer hover:bg-gray-600/50 rounded transition" title="Menu">
                            <span class="text-xs text-white">‚ò∞</span>
                        </button>
                        <!-- Dropdown Menu (posizionato via JS) -->
                        <div id="dashboard-menu-dropdown" class="hidden w-48 bg-gray-800 border border-gray-600 rounded-lg shadow-xl z-[100] overflow-hidden">
                            <button id="menu-tutorial" class="w-full px-4 py-2 text-left text-sm text-white hover:bg-gray-700 flex items-center gap-2">
                                <span>üìñ</span> Tutorial
                            </button>
                            <button id="menu-changelog" class="w-full px-4 py-2 text-left text-sm text-white hover:bg-gray-700 flex items-center gap-2">
                                <span>üìã</span> Changelog
                            </button>
                            <button id="menu-password" class="w-full px-4 py-2 text-left text-sm text-white hover:bg-gray-700 flex items-center gap-2">
                                <span>üîë</span> Cambia Password
                            </button>
                            <button id="menu-color-picker" class="w-full px-4 py-2 text-left text-sm text-white hover:bg-gray-700 flex items-center gap-2">
                                <span>üé®</span> Colore Squadra
                            </button>
                            <div class="border-t border-gray-700"></div>
                            <button id="menu-delete-team" class="w-full px-4 py-2 text-left text-sm text-red-500 hover:bg-red-900/50 flex items-center gap-2">
                                <span>üóëÔ∏è</span> Elimina Squadra
                            </button>
                        </div>
                    </div>
                    <!-- Selettore Colore (destra assoluto, allineato al titolo) -->
                    <div id="team-color-picker-container" class="absolute right-1.5 top-1">
                        <input type="color" id="team-color-picker"
                               class="w-5 h-5 sm:w-6 sm:h-6 rounded cursor-pointer border-2 border-gray-600 hover:border-white hover:scale-110 transition-all appearance-none bg-transparent [&::-webkit-color-swatch-wrapper]:p-0 [&::-webkit-color-swatch]:rounded [&::-webkit-color-swatch]:border-0"
                               title="Scegli il colore primario della squadra"
                               value="#22c55e">
                    </div>
                    <!-- Risorse (sotto il nome squadra) -->
                    <div id="risorse-box" class="mt-1 pt-1 border-t border-gray-700/50">
                        <div class="flex flex-wrap items-center justify-center sm:justify-between w-full gap-1">
                            <!-- Album e Ruota (sinistra) -->
                            <div class="flex items-center gap-1 order-1">
                                <button id="risorse-pacchetti" class="relative hidden h-8 px-2 flex items-center justify-center gap-1 rounded border border-amber-500/60 cursor-pointer hover:bg-yellow-800/30 transition" title="Album Figurine">
                                    <span class="text-lg">üé¥</span>
                                    <span class="text-xs text-yellow-300 font-bold">ALBUM</span>
                                    <span class="hidden" id="risorse-pacchetti-count"></span>
                                    <span id="album-free-alert" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-pulse border border-gray-900"></span>
                                </button>
                                <button id="risorse-ruota" class="relative hidden h-8 px-2 flex items-center justify-center gap-1 rounded border border-amber-500/60 cursor-pointer hover:bg-orange-800/30 transition" title="Ruota Fortuna">
                                    <span class="text-lg">üé°</span>
                                    <span class="text-xs text-orange-300 font-bold">RUOTA</span>
                                    <span class="hidden" id="risorse-ruota-status"></span>
                                    <span id="wheel-available-alert" class="hidden absolute -top-1 -right-0.5 w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse border border-gray-900"></span>
                                </button>
                            </div>
                            <!-- CS e CSS (riga sotto su mobile, centro su desktop) -->
                            <div class="flex items-center justify-center gap-2 order-3 sm:order-2 w-full sm:w-auto sm:flex-1 mt-1 sm:mt-0">
                                <!-- Crediti Seri -->
                                <div class="h-8 px-3 flex items-center gap-1 bg-gray-800/40 rounded border border-amber-500/60">
                                    <span class="text-base">üí∞</span>
                                    <span id="risorse-cs" class="text-sm text-green-400 font-bold">0</span>
                                    <span class="text-xs text-gray-400">CS</span>
                                </div>
                                <!-- Crediti Super Seri -->
                                <div class="h-8 px-3 flex items-center gap-1 bg-gray-800/40 rounded border border-amber-500/60">
                                    <span class="text-base">üíé</span>
                                    <span id="risorse-css" class="text-sm text-yellow-400 font-bold">0</span>
                                    <span class="text-xs text-gray-400">CSS</span>
                                </div>
                            </div>
                            <!-- Negozio (destra) -->
                            <button id="risorse-negozio" class="hidden h-8 px-2 flex items-center justify-center gap-1 rounded border border-amber-500/60 cursor-pointer hover:bg-yellow-800/30 transition order-2 sm:order-3" title="Negozio CSS">
                                <span class="text-lg">üõí</span>
                                <span class="text-xs text-yellow-300 font-bold">SHOP</span>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Elementi nascosti per compatibilita JS (fuori dal team-name-box) -->
                <div id="figurine-box" class="hidden"></div>
                <div id="daily-wheel-box" class="hidden"></div>
                <span id="risorse-separator-start" class="hidden"></span>
                <span id="risorse-separator" class="hidden"></span>
                <span id="risorse-separator-end" class="hidden"></span>
            </div>

            <!-- ========== TAB 1: HOME (Dashboard) ========== -->
            <div id="tab-home" class="tab-content">

                <!-- Box Squadra: Logo, Icona, Sponsor -->
                <div id="sponsor-media-box" class="rounded-lg border border-green-500/50">
                    <!-- MEDIA, LOGO, ICONA E SPONSOR - Riga principale -->
                    <div id="team-logo-container" class="flex flex-row flex-nowrap justify-center items-center gap-2 sm:gap-3 md:gap-4 overflow-visible">
                        <!-- LOGO SERIE SERIA (sinistra) -->
                        <img src="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/serie%20sera%20256.png"
                             alt="Serie SeriA Logo"
                             class="w-12 h-12 sm:w-14 sm:h-14 md:w-16 md:h-16 object-contain flex-shrink-0">
                        <!-- BOX MEDIA -->
                        <div id="media-box" class="hidden relative w-12 h-12 sm:w-14 sm:h-14 md:w-16 md:h-16 flex-shrink-0 cursor-pointer hover:scale-105 transition-transform duration-150" title="Clicca per scegliere Media Partner">
                            <img id="media-image"
                                 src="https://placehold.co/128x128/831843/f9a8d4?text=üì∫"
                                 alt="Media Partner"
                                 class="w-full h-full rounded-lg border-2 border-pink-500 shadow-md object-contain bg-gray-800 p-0.5 hover:border-pink-400"
                                 title="Media Partner">
                        </div>
                        <!-- LOGO SQUADRA -->
                        <div id="team-logo-wrapper" class="relative w-14 h-14 sm:w-16 sm:h-16 md:w-20 md:h-20 flex-shrink-0">
                            <img id="team-logo"
                                 src="https://raw.githubusercontent.com/carciofiatomici-bot/immaginiserie/main/placeholder.jpg"
                                 alt="Logo Squadra Modificabile"
                                 class="w-full h-full rounded-full border-3 cursor-pointer hover:opacity-80 transition duration-150 shadow-lg object-cover"
                                 style="border-color: #22c55e;"
                                 title="Clicca per cambiare il logo (Inserisci URL)">
                        </div>
                        <!-- ICONA SQUADRA -->
                        <div class="relative group flex-shrink-0">
                            <img id="team-icona-avatar"
                                 src="https://placehold.co/128x128/facc15/000?text=?"
                                 alt="Avatar Icona"
                                 class="w-14 h-14 sm:w-16 sm:h-16 md:w-20 md:h-20 rounded-full border-3 border-yellow-400 shadow-lg object-cover cursor-pointer">
                            <!-- Tooltip personalizzato -->
                            <div id="icona-tooltip" class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-50">
                                <p id="icona-tooltip-name" class="font-bold text-yellow-400">Icona</p>
                                <p id="icona-tooltip-level">Livello: --</p>
                                <p id="icona-tooltip-role">Ruolo: --</p>
                                <p id="icona-tooltip-type">Tipo: --</p>
                            </div>
                        </div>
                        <!-- BOX SPONSOR (destra dell'icona) -->
                        <div id="sponsor-box" class="hidden relative w-12 h-12 sm:w-14 sm:h-14 md:w-16 md:h-16 flex-shrink-0 cursor-pointer hover:scale-105 transition-transform duration-150" title="Clicca per scegliere Sponsor">
                            <img id="sponsor-image"
                                 src="https://placehold.co/128x128/78350f/fcd34d?text=ü§ù"
                                 alt="Sponsor"
                                 class="w-full h-full rounded-lg border-2 border-yellow-500 shadow-md object-contain bg-gray-800 p-0.5 hover:border-yellow-400"
                                 title="Sponsor">
                        </div>
                    </div>
                </div>

                <!-- BOX PROSSIMA PARTITA (Espanso) - Contenuto diretto da next-match-alert.js -->
                <div id="next-match-inline-box" class="mt-3 rounded-lg border border-green-500/50">
                    <h3 class="text-sm sm:text-base font-bold team-color-text mb-2 flex items-center gap-2">
                        <span>‚öΩ</span> Prossima Partita
                    </h3>
                    <div id="next-match-content">
                        <!-- Contenuto generato da next-match-alert.js -->
                        <p class="text-xs text-gray-500 text-center py-2">Caricamento...</p>
                    </div>
                </div>

                <!-- BOX SCHEDINA PRONOSTICI (Espanso) -->
                <div id="schedina-box" class="mt-3 rounded-lg border border-green-500/50">
                    <!-- Container per bottone schedina (gestito da next-match-alert.js) -->
                    <div id="schedina-inline-container" class="hidden">
                        <button id="next-match-schedina-btn"
                                class="w-full py-2 bg-green-600 hover:bg-green-500 rounded-lg text-white text-sm font-bold flex items-center justify-center gap-2 transition">
                            <span>üéØ</span> Compila Schedina
                        </button>
                    </div>
                </div>

                <!-- Elementi nascosti per compatibilita JS -->
                <div id="last-match-box" class="hidden">
                    <div id="last-match-content"></div>
                </div>
            </div>

            <!-- ========== TAB 2: GESTIONE SQUADRA ========== -->
            <div id="tab-squad" class="tab-content hidden">
                <!-- CONTAINER WIDGET GIOCATORI VICINI AL LEVEL-UP -->
                <div id="near-level-up-widget-container" class="mb-2">
                    <!-- Il widget EXP viene renderizzato qui dinamicamente -->
                </div>

                <!-- Divisa + Livello Rosa -->
                <div id="divisa-livello-box" class="flex items-center justify-between mb-2 p-2 sm:p-3 rounded-lg border bg-gray-900/30" style="border-color: var(--team-primary-color, rgba(34, 197, 94, 0.5))">
                    <!-- BOX DIVISA SQUADRA -->
                    <div id="team-uniform-box" class="flex-shrink-0 flex items-center justify-center cursor-pointer hover:opacity-80 transition duration-150" title="Clicca per modificare la divisa">
                        <svg id="uniform-preview-svg" viewBox="20 0 180 160" class="w-14 h-14 sm:w-16 sm:h-16">
                            <defs></defs>
                            <!-- Maglia stile jersey.xml -->
                            <g id="shirt-preview" transform="translate(0, 5)">
                                <!-- Corpo maglia con maniche integrate -->
                                <path id="dash-shirt-body" d="M 70,10 L 30,50 L 50,75 L 70,65 L 70,150 L 130,150 L 130,65 L 150,75 L 170,50 L 130,10 C 120,25 80,25 70,10 Z"
                                    fill="#22c55e" stroke="#1a1a2e" stroke-width="2"/>
                                <!-- Colletto -->
                                <path id="dash-shirt-collar" d="M 70,10 C 80,25 120,25 130,10 C 125,18 75,18 70,10 Z"
                                    fill="#ffffff" stroke="#1a1a2e" stroke-width="1"/>
                                <!-- Polsino sinistro -->
                                <path id="dash-shirt-cuff-left" d="M 30,50 L 50,75 L 45,80 L 25,55 Z"
                                    fill="#ffffff" stroke="#1a1a2e" stroke-width="1"/>
                                <!-- Polsino destro -->
                                <path id="dash-shirt-cuff-right" d="M 170,50 L 150,75 L 155,80 L 175,55 Z"
                                    fill="#ffffff" stroke="#1a1a2e" stroke-width="1"/>
                            </g>
                        </svg>
                    </div>
                    <!-- BOX LIVELLO MEDIO ROSA -->
                    <div class="px-2 flex flex-col items-center justify-center">
                        <p class="text-[8px] sm:text-[10px] text-gray-300 font-semibold leading-none">üìà Lv. Rosa</p>
                        <p class="leading-none"><span id="stat-rosa-level" class="text-sm sm:text-base font-extrabold text-white">N/A</span> <span id="stat-rosa-count" class="text-[8px] sm:text-[10px] text-gray-400">(0)</span></p>
                    </div>
                </div>

                <!-- BOX GESTIONE ROSA E FORMAZIONE -->
                <div id="gestione-box" class="rounded-lg border border-green-500/50 space-y-1.5 sm:space-y-2">
                    <!-- Riga Rosa e Formazione -->
                    <div class="grid grid-cols-2 gap-1.5 sm:gap-2">
                        <button id="btn-gestione-rosa"
                                class="w-full bg-gradient-to-r from-pink-600 to-rose-500 text-white font-extrabold py-2.5 sm:py-3 text-xs sm:text-base rounded-md shadow-lg hover:from-pink-500 hover:to-rose-400 transition duration-150 transform hover:scale-[1.02] active:scale-95">
                            üë• Rosa
                        </button>
                        <button id="btn-gestione-formazione"
                                class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-extrabold py-2.5 sm:py-3 text-xs sm:text-base rounded-md shadow-lg hover:from-indigo-500 hover:to-purple-500 transition duration-150 transform hover:scale-[1.02] active:scale-95">
                            üìã Formazione
                        </button>
                    </div>
                    <!-- Riga Stadio e Hall of Fame -->
                    <div id="stadio-hall-row" class="grid grid-cols-2 gap-1.5 sm:gap-2">
                        <button id="btn-stadium"
                                class="w-full bg-gradient-to-r from-emerald-600 to-green-500 text-white font-extrabold py-2.5 sm:py-3 text-xs sm:text-base rounded-md shadow-lg hover:from-emerald-500 hover:to-green-400 transition duration-150 transform hover:scale-[1.02] active:scale-95">
                            üèüÔ∏è Stadio
                        </button>
                        <button id="btn-hall-of-fame"
                                class="w-full bg-gradient-to-r from-amber-600 to-yellow-500 text-white font-extrabold py-2.5 sm:py-3 text-xs sm:text-base rounded-md shadow-lg hover:from-amber-500 hover:to-yellow-400 transition duration-150 transform hover:scale-[1.02] active:scale-95">
                            üèõÔ∏è Hall of Fame
                        </button>
                    </div>
                </div>

                <!-- Statistica nascosta per compatibilita JS -->
                <div class="hidden">
                    <p id="stat-formazione-level">N/A</p>
                </div>
            </div>

            <!-- ========== TAB 3: COMPETIZIONI ========== -->
            <div id="tab-competitions" class="tab-content hidden">
                <!-- BOX COMPETIZIONI (con toggle integrati) -->
                <div id="competizioni-box" class="rounded-lg border border-green-500/50">
                    <div class="space-y-1.5">
                        <!-- SerieSeriA con toggle -->
                        <div class="flex items-stretch gap-1.5">
                            <button id="btn-user-campionato"
                                    class="flex-1 bg-gradient-to-r from-green-600 to-green-700 text-white font-extrabold py-2 sm:py-2.5 rounded-md shadow-lg hover:from-green-500 hover:to-green-600 transition duration-150 transform hover:scale-[1.01] active:scale-95 flex items-center justify-center gap-1">
                                <span class="text-base sm:text-lg">üèÖ</span>
                                <span class="text-sm sm:text-base">SerieSeriA</span>
                            </button>
                            <div class="flex items-center bg-green-800/50 rounded-md px-2" title="Partecipa al campionato">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="championship-participation-toggle" class="sr-only peer">
                                    <div class="relative w-9 h-5 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500"></div>
                                </label>
                            </div>
                        </div>
                        <!-- CoppaSeriA con toggle -->
                        <div class="flex items-stretch gap-1.5">
                            <button id="btn-user-coppa"
                                    class="flex-1 bg-gradient-to-r from-purple-600 to-purple-700 text-white font-extrabold py-2 sm:py-2.5 rounded-md shadow-lg hover:from-purple-500 hover:to-purple-600 transition duration-150 transform hover:scale-[1.01] active:scale-95 flex items-center justify-center gap-1">
                                <span class="text-base sm:text-lg">üèÜ</span>
                                <span class="text-sm sm:text-base">CoppaSeriA</span>
                            </button>
                            <div class="flex items-center bg-purple-800/50 rounded-md px-2" title="Partecipa alla coppa">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="cup-participation-toggle" class="sr-only peer">
                                    <div class="relative w-9 h-5 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-500"></div>
                                </label>
                            </div>
                        </div>
                        <!-- Super CoppaSeriA (senza toggle) -->
                        <button id="btn-user-supercoppa"
                                class="w-full bg-gradient-to-r from-red-800 to-red-900 text-white font-extrabold py-2 sm:py-2.5 rounded-md shadow-lg hover:from-red-700 hover:to-red-800 transition duration-150 transform hover:scale-[1.01] active:scale-95 flex items-center justify-center gap-1">
                            <span class="text-base sm:text-lg">‚≠ê</span>
                            <span class="text-sm sm:text-base">Super CoppaSeriA</span>
                        </button>
                    </div>
                </div>

                <!-- Sfida -->
                <div class="mt-2">
                    <button id="btn-challenge"
                            class="w-full bg-gradient-to-r from-orange-600 to-red-600 text-white font-extrabold py-2.5 sm:py-3 text-xs sm:text-base rounded-md shadow-lg hover:from-orange-500 hover:to-red-500 transition duration-150 transform hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2">
                        <span>‚öîÔ∏è</span> Sfida Amichevole
                    </button>
                </div>

                <!-- BOX LEGA PRIVATA -->
                <div id="private-leagues-box" class="hidden mt-2 rounded-lg border border-green-500/50 flex justify-center">
                    <button id="btn-private-leagues"
                            class="flex-1 max-w-xs bg-gradient-to-r from-purple-600 to-violet-500 text-white font-extrabold py-2.5 sm:py-3 text-xs sm:text-base rounded-md shadow-lg hover:from-purple-500 hover:to-violet-400 transition duration-150 transform hover:scale-[1.02] active:scale-95">
                        üë• Lega Privata
                    </button>
                </div>
            </div>

            <!-- ========== TAB 4: SHOP ========== -->
            <div id="tab-shop" class="tab-content hidden">

                <!-- BOX DRAFT/MERCATO/SCAMBI -->
                <div id="draft-scambi-box" class="rounded-lg border border-green-500/50 space-y-2">
                    <!-- Draft con Toggle -->
                    <div id="btn-draft-container"
                         class="bg-gradient-to-r from-yellow-600 to-amber-500 text-white font-extrabold text-sm sm:text-base rounded-md shadow-lg hover:from-yellow-500 hover:to-amber-400 transition duration-150 flex items-center overflow-hidden">
                        <!-- Parte cliccabile per navigazione -->
                        <button id="btn-draft-utente"
                                class="flex-1 py-2.5 sm:py-3 px-2 text-left flex items-center justify-center gap-2 hover:bg-white/10 transition active:scale-95">
                            üìù Draft Calciatori
                        </button>
                        <!-- Separatore -->
                        <div class="w-px h-8 bg-yellow-800/50"></div>
                        <!-- Toggle Switch per partecipazione Draft -->
                        <div id="draft-toggle-container" class="px-2 sm:px-3 py-2 flex items-center" title="Partecipa al Draft">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="draft-participation-toggle" class="sr-only peer">
                                <div class="w-9 h-5 sm:w-10 sm:h-6 bg-yellow-900/60 peer-focus:outline-none rounded-full peer
                                            peer-checked:after:translate-x-full peer-checked:after:border-white
                                            after:content-[''] after:absolute after:top-[2px] after:left-[2px]
                                            after:bg-white after:border-gray-300 after:border after:rounded-full
                                            after:h-4 after:w-4 sm:after:h-5 sm:after:w-5 after:transition-all
                                            peer-checked:bg-green-500"></div>
                            </label>
                        </div>
                    </div>

                    <!-- Mercato -->
                    <button id="btn-mercato-utente"
                            class="w-full bg-gradient-to-r from-blue-600 to-cyan-500 text-white font-extrabold py-2.5 sm:py-3 text-sm sm:text-base rounded-md shadow-lg hover:from-blue-500 hover:to-cyan-400 transition duration-150 transform hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2">
                        üí∞ Mercato Svincolati
                    </button>

                    <!-- Scambi -->
                    <button id="btn-trades"
                            class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-extrabold py-2.5 sm:py-3 text-sm sm:text-base rounded-md shadow-lg hover:from-purple-500 hover:to-indigo-500 transition duration-150 transform hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2">
                        üîÑ Scambi tra Squadre
                    </button>
                </div>

                <!-- Widget CSS rimosso - ora nel box risorse in cima -->
                <div id="css-dashboard-widget" class="hidden"></div>
                <div id="draft-mercato-container" class="hidden"></div>
            </div>

            <!-- ========== TAB 5: REGOLE ========== -->
            <div id="tab-rules" class="tab-content hidden">
                <!-- Header Regole -->
                <div class="rounded-lg p-4 mb-3 border-b-2 border-yellow-500/50">
                    <h2 class="text-2xl font-bold text-white text-center">Regole del Gioco</h2>
                    <p class="text-gray-300 text-center text-sm mt-1">Serie SeriA - Fantacalcio</p>
                </div>

                <!-- Contenuto Regole (Accordion) -->
                <div class="space-y-2">

                    <!-- Sezione Squadra -->
                    <div class="bg-gray-900/60 rounded-lg border border-yellow-500/50 overflow-hidden">
                        <button onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('span:last-child').textContent = this.nextElementSibling.classList.contains('hidden') ? '‚ñ∂' : '‚ñº';"
                                class="w-full p-3 flex justify-between items-center text-left hover:bg-gray-800/50 transition">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">‚öΩ</span>
                                <h3 class="text-base font-bold text-yellow-400">La Squadra</h3>
                            </div>
                            <span class="text-yellow-400">‚ñ∂</span>
                        </button>
                        <div class="hidden p-3 border-t border-yellow-700/50 bg-gray-800/30">
                            <ul class="text-gray-300 space-y-1.5 text-sm">
                                <li>‚Ä¢ Ogni squadra ha <strong class="text-white">15 giocatori + 1 Icona</strong></li>
                                <li>‚Ä¢ <strong class="text-white">Formazione:</strong> 5 titolari + 3 panchina</li>
                                <li>‚Ä¢ <strong class="text-white">Moduli:</strong> 1-2-2, 1-1-2-1, 1-3-1, 1-1-3</li>
                                <li>‚Ä¢ Ruoli: <span class="text-blue-400">P</span>, <span class="text-green-400">D</span>, <span class="text-yellow-400">C</span>, <span class="text-red-400">A</span></li>
                                <li>‚Ä¢ Tipologie: <span class="text-red-400">Potenza</span> > <span class="text-blue-400">Tecnica</span> > <span class="text-yellow-400">Velocita</span></li>
                            </ul>
                        </div>
                    </div>

                    <!-- Sezione Livelli -->
                    <div class="bg-gray-900/60 rounded-lg border border-sky-500/50 overflow-hidden">
                        <button onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('span:last-child').textContent = this.nextElementSibling.classList.contains('hidden') ? '‚ñ∂' : '‚ñº';"
                                class="w-full p-3 flex justify-between items-center text-left hover:bg-gray-800/50 transition">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">üìä</span>
                                <h3 class="text-base font-bold text-sky-400">Livelli e Modificatori</h3>
                            </div>
                            <span class="text-sky-400">‚ñ∂</span>
                        </button>
                        <div class="hidden p-3 border-t border-sky-700/50 bg-gray-800/30">
                            <p class="text-gray-300 text-sm mb-2">Il livello determina il modificatore bonus ai tiri.</p>
                            <div class="grid grid-cols-3 gap-2 text-xs">
                                <div class="space-y-0.5">
                                    <div class="flex justify-between"><span class="text-gray-400">Liv 1-2</span><span class="text-white">0.5</span></div>
                                    <div class="flex justify-between"><span class="text-gray-400">Liv 5-6</span><span class="text-white">1.5</span></div>
                                    <div class="flex justify-between"><span class="text-gray-400">Liv 9-10</span><span class="text-white">2.5</span></div>
                                </div>
                                <div class="space-y-0.5">
                                    <div class="flex justify-between"><span class="text-gray-400">Liv 13-14</span><span class="text-white">3.5</span></div>
                                    <div class="flex justify-between"><span class="text-gray-400">Liv 17-18</span><span class="text-white">4.5</span></div>
                                    <div class="flex justify-between"><span class="text-gray-400">Liv 21-22</span><span class="text-white">5.5</span></div>
                                </div>
                                <div class="space-y-0.5">
                                    <div class="flex justify-between"><span class="text-gray-400">Liv 25-26</span><span class="text-white">6.5</span></div>
                                    <div class="flex justify-between"><span class="text-yellow-400">Liv 29</span><span class="text-yellow-400">8.0</span></div>
                                    <div class="flex justify-between"><span class="text-yellow-400">Liv 30</span><span class="text-yellow-400">9.0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sezione Partita -->
                    <div class="bg-gray-900/60 rounded-lg border border-green-500/50 overflow-hidden">
                        <button onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('span:last-child').textContent = this.nextElementSibling.classList.contains('hidden') ? '‚ñ∂' : '‚ñº';"
                                class="w-full p-3 flex justify-between items-center text-left hover:bg-gray-800/50 transition">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">üéÆ</span>
                                <h3 class="text-base font-bold text-green-400">La Partita</h3>
                            </div>
                            <span class="text-green-400">‚ñ∂</span>
                        </button>
                        <div class="hidden p-3 border-t border-green-700/50 bg-gray-800/30">
                            <ul class="text-gray-300 space-y-1.5 text-sm">
                                <li>‚Ä¢ <strong class="text-white">50 occasioni</strong> per partita (25 per squadra)</li>
                                <li>‚Ä¢ 3 fasi: <span class="text-cyan-400">Costruzione</span> ‚Üí <span class="text-orange-400">Attacco</span> ‚Üí <span class="text-red-400">Tiro</span></li>
                                <li>‚Ä¢ Le abilita si attivano automaticamente</li>
                                <li>‚Ä¢ La forma modifica il livello effettivo</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Sezione Forma -->
                    <div class="bg-gray-900/60 rounded-lg border border-orange-500/50 overflow-hidden">
                        <button onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('span:last-child').textContent = this.nextElementSibling.classList.contains('hidden') ? '‚ñ∂' : '‚ñº';"
                                class="w-full p-3 flex justify-between items-center text-left hover:bg-gray-800/50 transition">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">üí™</span>
                                <h3 class="text-base font-bold text-orange-400">Sistema Forma</h3>
                            </div>
                            <span class="text-orange-400">‚ñ∂</span>
                        </button>
                        <div class="hidden p-3 border-t border-orange-700/50 bg-gray-800/30">
                            <p class="text-gray-300 text-sm mb-2">Range: <strong>-3</strong> a <strong>+3</strong></p>
                            <div class="space-y-1 text-xs">
                                <div class="flex justify-between text-green-400"><span>Gol/Assist/Clean sheet</span><span>+1</span></div>
                                <div class="flex justify-between text-red-400"><span>Panchina consecutiva</span><span>-1 (chance)</span></div>
                                <div class="flex justify-between text-purple-400"><span>Random dopo partita</span><span>¬±1 (20%)</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Sezione Valute -->
                    <div class="bg-gray-900/60 rounded-lg border border-amber-500/50 overflow-hidden">
                        <button onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('span:last-child').textContent = this.nextElementSibling.classList.contains('hidden') ? '‚ñ∂' : '‚ñº';"
                                class="w-full p-3 flex justify-between items-center text-left hover:bg-gray-800/50 transition">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">üí∞</span>
                                <h3 class="text-base font-bold text-amber-400">Valute</h3>
                            </div>
                            <span class="text-amber-400">‚ñ∂</span>
                        </button>
                        <div class="hidden p-3 border-t border-amber-700/50 bg-gray-800/30">
                            <ul class="text-gray-300 space-y-1.5 text-sm">
                                <li>‚Ä¢ <strong class="text-white">CS</strong>: Crediti per acquisti giocatori</li>
                                <li>‚Ä¢ <strong class="text-amber-400">CSS</strong>: Premium per potenziamenti</li>
                                <li>‚Ä¢ CS: vinci partite e stagioni</li>
                                <li>‚Ä¢ CSS: vinci trofei (Campionato, Coppa)</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Sezione Competizioni -->
                    <div class="bg-gray-900/60 rounded-lg border border-purple-500/50 overflow-hidden">
                        <button onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('span:last-child').textContent = this.nextElementSibling.classList.contains('hidden') ? '‚ñ∂' : '‚ñº';"
                                class="w-full p-3 flex justify-between items-center text-left hover:bg-gray-800/50 transition">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">üèÜ</span>
                                <h3 class="text-base font-bold text-purple-400">Competizioni</h3>
                            </div>
                            <span class="text-purple-400">‚ñ∂</span>
                        </button>
                        <div class="hidden p-3 border-t border-purple-700/50 bg-gray-800/30">
                            <ul class="text-gray-300 space-y-1.5 text-sm">
                                <li>‚Ä¢ <span class="text-green-400">SerieSeriA</span>: Girone unico, tutti vs tutti</li>
                                <li>‚Ä¢ <span class="text-purple-400">CoppaSeriA</span>: Eliminazione diretta</li>
                                <li>‚Ä¢ <span class="text-yellow-400">Supercoppa</span>: Campione vs Coppa</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Sezione Enciclopedia -->
                    <div class="bg-gray-900/60 rounded-lg border border-pink-500/50 overflow-hidden">
                        <button onclick="if(window.AbilitiesEncyclopediaUI?.open) window.AbilitiesEncyclopediaUI.open();"
                                class="w-full p-3 flex justify-between items-center text-left hover:bg-gray-800/50 transition">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">üìî</span>
                                <h3 class="text-base font-bold text-pink-400">Enciclopedia Abilita</h3>
                            </div>
                            <span class="text-pink-400">‚Üí</span>
                        </button>
                    </div>

                </div>
            </div>

            <!-- Toggle ora integrati nel box competizioni sopra -->

            <span id="team-firestore-id" class="hidden">N/A</span>
            <!-- Bottoni nascosti per compatibilita JS esistente -->
            <button id="user-back-to-login-button" class="hidden"></button>
            <button id="btn-delete-team" class="hidden"></button>

            <!-- Bottone Torna al Pannello Admin - Visibile SOLO se si accede dalla dashboard admin -->
            <div id="admin-return-button-container" class="mt-4 hidden">
                <button id="btn-return-to-admin"
                        class="w-full bg-indigo-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-indigo-500 transition duration-150 transform hover:scale-[1.02]">
                    üîß Torna al Pannello Admin
                </button>
            </div>

            <!-- Bottoni utility ora nel menu hamburger - questi sono nascosti per compatibilita JS -->
            <div class="hidden">
                <button id="btn-goto-admin-panel"></button>
                <button id="btn-start-tutorial"></button>
                <button id="btn-show-changelog-dashboard"></button>
                <button id="btn-change-password"></button>
            </div>
            <div id="pwa-update-button-container" class="hidden">
                <button id="btn-check-pwa-update"></button>
            </div>
        </div>
        
        <!-- 4. CONTENUTO AREA AMMINISTRATORE - Dashboard Principale -->
        <div id="admin-content" class="football-box w-full max-w-3xl transition duration-500 hidden-on-load pb-20">
            <!-- Contenitore per i pulsanti principali e liste squadre -->
            <div id="admin-dashboard-container" class="p-6 bg-gray-700 rounded-lg border-2 border-red-500 shadow-xl">
                <!-- Il layout √® generato da admin.js -->
                <p class="text-gray-400 text-center">Inizializzazione...</p>
            </div>
            
            <!-- Bottone Torna alla Dashboard (solo per squadre admin, non serieseria) -->
            <div id="admin-return-dashboard-container" class="mt-6 hidden">
                <button id="btn-return-to-team-dashboard"
                        class="w-full py-3 px-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold rounded-lg shadow-lg transition transform hover:scale-[1.01] flex items-center justify-center gap-3 border-2 border-blue-400">
                    <span class="text-xl">üè†</span>
                    <span id="return-dashboard-team-name">Torna alla Dashboard</span>
                </button>
            </div>

            <div class="mt-4 flex gap-3">
                <button id="btn-admin-changelog"
                        onclick="window.Changelog?.showAdmin()"
                        class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-xl hover:bg-indigo-500 transition duration-150 transform hover:scale-[1.02] flex items-center justify-center gap-2">
                    <span>üìã</span> Changelog
                </button>
                <button id="admin-logout-button"
                        class="flex-1 bg-red-500 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-red-400 transition duration-150 transform hover:scale-[1.02]">
                    Logout Admin
                </button>
            </div>
        </div>
        
        <!-- 5. CONTENUTO AREA DRAFT (Utente) - NASCOSTO -->
        <div id="draft-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load pb-20">
             <h2 class="text-4xl font-extrabold text-yellow-400 text-center mb-4 border-b-4 border-yellow-700 pb-2">Gestione Draft Calciatori</h2>
             <!-- CONTAINER DRAFT STATUS BOX (giocatori disponibili e ordine draft) - SOPRA il box turno -->
             <div id="draft-status-box-container" class="mt-6 hidden">
                 <!-- Il box stato draft viene renderizzato qui dinamicamente da draft-status-box.js -->
             </div>
             <div id="draft-tools-container" class="mt-4">
                <p class="text-center text-gray-400">Strumenti di gestione Draft in caricamento...</p>
             </div>
             <button id="draft-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Indietro
            </button>
        </div>
        
        <!-- 6. CONTENUTO AREA CLASSIFICA - NASCOSTO -->
        <div id="leaderboard-content" class="football-box w-full max-w-2xl transition duration-500 hidden-on-load pb-20">
             <h2 class="text-4xl font-extrabold text-blue-400 text-center mb-4 border-b-4 border-blue-700 pb-2">Classifica Generale Lega</h2>
             <p class="text-center text-lg text-gray-300">Qui vedrai la classifica aggiornata di tutte le squadre.</p>
             <div class="mt-8 p-6 bg-gray-700 rounded-lg border-2 border-blue-500 text-center shadow-lg">
                <p class="text-white font-semibold">I dati della classifica saranno caricati qui.</p>
             </div>
             <button id="leaderboard-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Torna al Login
            </button>
        </div>
        
        <!-- 7. CONTENUTO AREA CALENDARIO - NASCOSTO -->
        <div id="schedule-content" class="football-box w-full max-w-2xl transition duration-500 hidden-on-load pb-20">
             <h2 class="text-4xl font-extrabold text-teal-400 text-center mb-4 border-b-4 border-teal-700 pb-2">Calendario Partite</h2>
             <p class="text-center text-lg text-gray-300">Consulta qui le sfide e i risultati di ogni giornata.</p>
             <div class="mt-8 p-6 bg-gray-700 rounded-lg border-2 border-teal-500 text-center shadow-lg">
                <p class="text-white font-semibold">I dati del calendario saranno caricati qui.</p>
             </div>
             <button id="schedule-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Torna al Login
            </button>
        </div>
        
        <!-- 7B. CONTENUTO AREA CAMPIONATO UTENTE (NUOVA) -->
        <div id="user-campionato-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load pb-20">
             <h2 class="text-4xl font-extrabold text-green-400 text-center mb-4 border-b-4 border-green-700 pb-2">üèÜ SerieSeriA</h2>
             <p class="text-center text-lg text-gray-300 mb-6">Prossima partita, classifica e calendario</p>
             <div id="user-campionato-container" class="mt-6 space-y-6">
                <p class="text-center text-gray-400">Caricamento dati campionato...</p>
             </div>
             <button id="user-campionato-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                ‚Üê Torna alla Dashboard
            </button>
        </div>

        <!-- 7C. CONTENUTO AREA COPPA UTENTE (NUOVA) -->
        <div id="user-coppa-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load pb-20">
             <h2 class="text-4xl font-extrabold text-purple-400 text-center mb-4 border-b-4 border-purple-700 pb-2">üèÜ CoppaSeriA</h2>
             <p class="text-center text-lg text-gray-300 mb-6">Prossima partita e tabellone</p>
             <div id="user-coppa-container" class="mt-6 space-y-6">
                <p class="text-center text-gray-400">Caricamento dati coppa...</p>
             </div>
             <button id="user-coppa-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                ‚Üê Torna alla Dashboard
            </button>
        </div>

        <!-- 7D. CONTENUTO AREA SUPERCOPPA UTENTE (NUOVA) -->
        <div id="user-supercoppa-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load pb-20">
             <h2 class="text-4xl font-extrabold text-yellow-400 text-center mb-4 border-b-4 border-yellow-700 pb-2">‚≠ê Super CoppaSeriA</h2>
             <p class="text-center text-lg text-gray-300 mb-6">Stato e risultato della Super CoppaSeriA</p>
             <div id="user-supercoppa-container" class="mt-6 space-y-6">
                <p class="text-center text-gray-400">Caricamento dati supercoppa...</p>
             </div>
             <button id="user-supercoppa-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                ‚Üê Torna alla Dashboard
            </button>
        </div>

        <!-- 7E. CONTENUTO AREA CAMPIONATO UTENTE (VECCHIO - DA RIMUOVERE) -->
        <div id="user-championship-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load pb-20">
             <h2 class="text-4xl font-extrabold text-purple-400 text-center mb-4 border-b-4 border-purple-700 pb-2">üèÜ Gestione Campionato</h2>
             <p class="text-center text-lg text-gray-300 mb-6">Simula le partite della tua lega e segui l'andamento</p>
             <div id="user-championship-tools-container" class="mt-6">
                <p class="text-center text-gray-400">Strumenti di simulazione in caricamento...</p>
             </div>
             <button id="user-championship-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Torna alla Dashboard
            </button>
        </div>

        <!-- 8. CONTENUTO AREA IMPOSTAZIONI CAMPIONATO - NASCOSTO -->
        <div id="championship-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load pb-20">
             <h2 class="text-4xl font-extrabold text-orange-400 text-center mb-4 border-b-4 border-orange-700 pb-2">Impostazioni e Regole Campionato</h2>
             <div id="championship-tools-container" class="mt-6">
                <p class="text-center text-gray-400">Strumenti di gestione Campionato in caricamento...</p>
             </div>
             <button id="championship-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Torna al Pannello Admin
            </button>
        </div>

        <!-- 9. CONTENUTO AREA GESTIONE SQUADRA (Rosa e Formazione) -->
        <div id="squadra-content" class="football-box w-full max-w-5xl transition duration-500 hidden-on-load pb-20">
             <h2 id="squadra-main-title" class="text-4xl font-extrabold text-green-400 text-center mb-4 border-b-4 border-green-700 pb-2">Gestione Rosa</h2>
             <p id="squadra-subtitle" class="text-center text-lg text-gray-300 mb-6">Visualizza e gestisci i tuoi calciatori.</p>
             
             <!-- Contenitore logica Gestione Rosa o Formazione -->
             <div id="squadra-tools-container" class="mt-6">
                <p class="text-center text-gray-400">Contenuto in caricamento...</p>
             </div>
             
             <button id="squadra-back-button"
                    class="mt-6 w-full bg-yellow-500 text-gray-900 font-extrabold py-3 rounded-lg shadow-xl hover:bg-yellow-400 transition duration-150 transform hover:scale-[1.02]">
                Torna alla Dashboard
            </button>
        </div>

        <!-- 10. CONTENUTO AREA MERCATO (Acquisti Liberi) - NASCOSTO -->
        <div id="mercato-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load pb-20">
             <h2 class="text-4xl font-extrabold text-blue-400 text-center mb-4 border-b-4 border-blue-700 pb-2">Mercato Fuori Lista</h2>
             <div id="mercato-tools-container" class="mt-6">
                <p class="text-center text-gray-400">Contenuto Mercato in caricamento...</p>
             </div>
             <button id="mercato-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Torna alla Dashboard
            </button>
        </div>

        <!-- 10b. CONTENUTO HALL OF FAME (Storico Partite) - NASCOSTO -->
        <div id="match-history-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load pb-20">
             <h2 class="text-4xl font-extrabold text-amber-400 text-center mb-4 border-b-4 border-amber-600 pb-2">üèõÔ∏è Hall of Fame</h2>
             <div id="match-history-tools-container" class="mt-6">
                <p class="text-center text-gray-400">Caricamento storico partite...</p>
             </div>
             <button id="match-history-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Torna alla Dashboard
            </button>
        </div>

        <!-- 10c. CONTENUTO STADIO - NASCOSTO -->
        <div id="stadium-content" class="football-box w-full max-w-5xl transition duration-500 hidden-on-load pb-20">
            <!-- Il contenuto e' iniettato da stadium-ui.js -->
            <p class="text-center text-gray-400 p-8">Caricamento stadio...</p>
        </div>

        <!-- 10d. CONTENUTO LEGHE PRIVATE - NASCOSTO -->
        <div id="private-leagues-content" class="football-box w-full max-w-2xl transition duration-500 hidden-on-load pb-20">
            <div class="flex items-center justify-between p-4 border-b border-gray-700">
                <h2 class="text-2xl font-bold text-purple-400">
                    <i class="fas fa-users mr-2"></i>Leghe Private
                </h2>
                <button id="private-leagues-back-button"
                        class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-arrow-left mr-2"></i>Indietro
                </button>
            </div>
            <!-- Il contenuto e' iniettato da private-leagues-ui.js -->
            <div id="private-leagues-panel">
                <p class="text-center text-gray-400 p-8">Caricamento...</p>
            </div>
        </div>

        <!-- 11. CONTENUTO: GESTIONE GIOCATORI ADMIN -->
        <div id="player-management-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load pb-20">
             <h2 class="text-4xl font-extrabold text-yellow-400 text-center mb-4 border-b-4 border-yellow-700 pb-2">Gestione Calciatori (Creazione e Liste)</h2>
             
             <!-- Il contenuto √® iniettato da admin.js -->
             <div id="player-management-tools-container" class="mt-6">
                <p class="text-center text-gray-400">Caricamento strumenti...</p>
             </div>

             <button id="player-management-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Torna alla Dashboard Admin
            </button>
        </div>

        <!-- 12. NUOVO CONTENUTO: GESTIONE SQUADRE ADMIN -->
        <div id="team-management-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load pb-20">
             <h2 class="text-4xl font-extrabold text-blue-500 text-center mb-4 border-b-4 border-blue-700 pb-2">Gestione Squadre Registrate</h2>
             
             <!-- Il contenuto √® iniettato da admin.js -->
             <div id="team-management-tools-container" class="mt-6">
                <p class="text-center text-gray-400">Caricamento strumenti...</p>
             </div>

             <button id="team-management-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Torna alla Dashboard Admin
            </button>
        </div>

        <!-- 12b. NUOVO CONTENUTO: GESTIONE FEATURE FLAGS -->
        <div id="feature-flags-content" class="football-box w-full max-w-4xl transition duration-500 hidden-on-load pb-20">
             <h2 class="text-4xl font-extrabold text-purple-500 text-center mb-4 border-b-4 border-purple-700 pb-2">
                <i class="fas fa-flag mr-2"></i> Gestione Feature Flags
             </h2>

             <!-- Il contenuto e' iniettato da admin-feature-flags.js -->
             <div id="feature-flags-tools-container" class="mt-6">
                <p class="text-center text-gray-400">Caricamento strumenti...</p>
             </div>

             <button id="feature-flags-back-button"
                    class="mt-6 w-full bg-gray-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-gray-500 transition duration-150 transform hover:scale-[1.02]">
                Torna alla Dashboard Admin
            </button>
        </div>

        <!-- 13. NUOVO CONTENUTO: SELEZIONE ALLENATORE -->
        <div id="coach-selection-box" class="football-box w-full max-w-xl transition duration-500 hidden-on-load">
            <h2 class="text-4xl font-extrabold text-red-500 text-center mb-4 border-b-4 border-red-700 pb-2">Un Manager per la Tua Squadra</h2>
            <p class="text-center text-lg text-gray-300 mb-6">Inserisci il nome dell'allenatore che guider√† la squadra. Partir√† da Livello 1 e Potr√† crescere.</p>
            
            <input type="text" id="coach-name-input" placeholder="Nome Allenatore (es. Carlo Ancelotti)"
                   class="w-full p-3 border border-red-600 rounded-lg focus:ring-red-400 focus:border-red-400 bg-gray-700 text-white mb-4 shadow-inner-dark">
            
            <button id="btn-confirm-coach"
                    class="w-full bg-red-500 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-red-400 transition duration-150 transform hover:scale-[1.02]">
                Conferma e Scegli l'Icona
            </button>
            
            <p id="coach-selection-message" class="text-center mt-3 text-red-400"></p>
        </div>
        
        <!-- 14. CONTENUTO: SELEZIONE ICONA -->
        <div id="captain-selection-box" class="football-box w-full max-w-3xl transition duration-500 hidden-on-load">
             <h2 class="text-4xl font-extrabold text-orange-400 text-center mb-4 border-b-4 border-orange-700 pb-2">Seleziona la tua Icona!</h2>
             <p id="captain-message" class="text-center text-lg text-gray-300 mb-6">Scegli l'Icona che guider√† la tua squadra. Sar√† il tuo giocatore speciale in rosa.</p>
             
             <div id="captain-candidates-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                <p class="text-center text-gray-400 col-span-4">Caricamento candidati...</p>
             </div>
             
             <p id="captain-selection-error" class="text-center mt-6 text-red-400"></p>
             
             <button id="btn-confirm-captain"
                    class="mt-6 w-full bg-green-500 text-gray-900 font-extrabold py-3 rounded-lg shadow-xl hover:bg-green-400 transition duration-150 transform hover:scale-[1.02]" disabled>
                Conferma Icona e Vai alla Dashboard
            </button>
        </div>
        
        
        <!-- 15. MODALE DI CONFERMA ELIMINAZIONE SQUADRA (Globale) -->
        <div id="delete-team-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50 hidden">
            <div class="football-box w-full max-w-sm">
                <h3 class="text-3xl font-bold text-red-400 mb-4 border-b border-red-600 pb-2 text-center">ELIMINA SQUADRA</h3>
                <p class="text-lg text-gray-300 mb-4 text-center">Sei sicuro di voler eliminare definitivamente <span id="team-name-to-delete" class="font-extrabold text-yellow-400">[Nome Squadra]</span>?</p>
                
                <p class="text-red-400 font-bold mb-4 text-center">Questa azione √® irreversibile.</p>

                <label for="delete-confirmation-input" class="block text-gray-300 font-semibold mb-2">Digita "ELIMINA" per confermare:</label>
                <input type="text" id="delete-confirmation-input" 
                       class="w-full p-3 mb-4 rounded-lg bg-gray-700 border border-red-600 text-white uppercase text-center font-extrabold focus:ring-red-400">

                <div class="flex justify-between space-x-4">
                    <button id="btn-cancel-delete"
                            class="w-1/2 bg-gray-500 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-gray-400 transition duration-150">
                        Annulla
                    </button>
                    <button id="btn-confirm-delete-final"
                            class="w-1/2 bg-red-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-red-500 transition duration-150" disabled>
                        Conferma Eliminazione
                    </button>
                </div>
                <p id="delete-message" class="text-center mt-3 text-red-400"></p>
            </div>
        </div>

        <!-- 16. MODALE LISTA ICONE -->
        <div id="lista-icone-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-start justify-center p-2 pt-4 z-50 hidden overflow-y-auto">
            <div class="football-box w-full max-w-4xl mx-auto mb-4 max-h-[95vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4 border-b border-yellow-600 pb-2 sticky top-0 bg-gray-800 pt-2 -mt-2 z-10">
                    <h3 class="text-2xl md:text-3xl font-bold text-yellow-400">üëë Lista Icone</h3>
                    <button id="btn-close-lista-icone" class="text-white hover:text-red-400 text-3xl font-bold">‚úï</button>
                </div>
                <p class="text-gray-300 mb-4 text-center text-sm">Scegli un'Icona quando crei la tua squadra!</p>
                <div id="lista-icone-container" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <!-- Le icone vengono caricate dinamicamente -->
                </div>
                <button id="btn-back-to-login"
                        class="mt-4 w-full bg-yellow-500 text-gray-900 font-extrabold py-3 rounded-lg shadow-xl hover:bg-yellow-400 transition duration-150">
                    Chiudi
                </button>
            </div>
        </div>

        <!-- 16B. MODALE LISTA SQUADRE -->
        <div id="lista-squadre-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-start justify-center p-2 pt-4 z-50 hidden overflow-y-auto">
            <div class="football-box w-full max-w-4xl mx-auto mb-4 max-h-[95vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4 border-b border-green-600 pb-2 sticky top-0 bg-gray-800 pt-2 -mt-2 z-10">
                    <h3 class="text-2xl md:text-3xl font-bold text-green-400">üìã Squadre</h3>
                    <button id="btn-close-lista-squadre" class="text-white hover:text-red-400 text-3xl font-bold">‚úï</button>
                </div>
                <p class="text-gray-300 mb-4 text-center text-sm">Tutte le squadre della lega</p>
                <div id="lista-squadre-container" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <!-- Le squadre vengono caricate dinamicamente -->
                    <p class="text-center text-gray-400 col-span-2">Caricamento squadre...</p>
                </div>
                <button id="btn-back-from-squadre"
                        class="mt-4 w-full bg-green-500 text-gray-900 font-extrabold py-3 rounded-lg shadow-xl hover:bg-green-400 transition duration-150">
                    Chiudi
                </button>
            </div>
        </div>

        <!-- 17. MODALE EDITOR DIVISA -->
        <div id="uniform-editor-modal" class="fixed inset-0 bg-black bg-opacity-90 items-center justify-center p-4 z-50 hidden overflow-y-auto">
            <div class="football-box w-full max-w-4xl mx-auto my-8">
                <div class="flex justify-between items-center mb-4 border-b border-purple-600 pb-2">
                    <h3 class="text-3xl font-bold text-purple-400">üëï Editor Divisa</h3>
                    <button id="btn-close-uniform-editor" class="text-white hover:text-red-400 text-3xl font-bold">‚úï</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- ANTEPRIMA DIVISA COMPLETA -->
                    <div class="bg-gray-800 rounded-lg p-4 border-2 border-gray-600">
                        <h4 class="text-lg font-bold text-white mb-4 text-center">Anteprima Divisa</h4>
                        <svg id="uniform-full-preview" viewBox="0 0 200 260" class="w-full max-w-xs mx-auto">
                            <!-- Definizioni pattern -->
                            <defs id="uniform-patterns-defs"></defs>

                            <!-- MAGLIA (stile jersey.xml) -->
                            <g id="editor-shirt-preview" transform="translate(0, 10)">
                                <!-- Corpo maglia con maniche integrate -->
                                <path id="editor-shirt-body" d="M 70,10 L 30,50 L 50,75 L 70,65 L 70,150 L 130,150 L 130,65 L 150,75 L 170,50 L 130,10 C 120,25 80,25 70,10 Z"
                                    fill="#22c55e" stroke="#1a1a2e" stroke-width="2"/>
                                <!-- Colletto -->
                                <path id="editor-shirt-collar" d="M 70,10 C 80,25 120,25 130,10 C 125,18 75,18 70,10 Z"
                                    fill="#ffffff" stroke="#1a1a2e" stroke-width="1.5"/>
                                <!-- Polsino sinistro -->
                                <path id="editor-shirt-cuff-left" d="M 30,50 L 50,75 L 45,80 L 25,55 Z"
                                    fill="#ffffff" stroke="#1a1a2e" stroke-width="1.5"/>
                                <!-- Polsino destro -->
                                <path id="editor-shirt-cuff-right" d="M 170,50 L 150,75 L 155,80 L 175,55 Z"
                                    fill="#ffffff" stroke="#1a1a2e" stroke-width="1.5"/>
                            </g>

                            <!-- PANTALONCINI (stile jersey.xml) -->
                            <g id="editor-shorts-preview" transform="translate(0, 170)">
                                <!-- Corpo pantaloncini -->
                                <path id="editor-shorts-body" d="M 65,0 L 135,0 L 145,70 L 105,70 L 100,40 L 95,70 L 55,70 L 65,0 Z"
                                    fill="#1a1a2e" stroke="#1a1a2e" stroke-width="2"/>
                                <!-- Striscia laterale sinistra -->
                                <path id="editor-shorts-stripe-left" d="M 65,0 L 55,70 L 60,70 L 70,0 Z"
                                    fill="#ffffff" stroke="none"/>
                                <!-- Striscia laterale destra -->
                                <path id="editor-shorts-stripe-right" d="M 135,0 L 145,70 L 140,70 L 130,0 Z"
                                    fill="#ffffff" stroke="none"/>
                            </g>
                        </svg>
                    </div>

                    <!-- CONTROLLI EDITOR -->
                    <div class="space-y-4">
                        <!-- MAGLIA -->
                        <div class="bg-gray-800 rounded-lg p-4 border-2 border-green-600">
                            <h4 class="text-lg font-bold text-green-400 mb-3">üëï Maglia</h4>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-sm text-gray-300 mb-1">Primario</label>
                                    <input type="color" id="shirt-color-primary" value="#22c55e" class="w-full h-10 rounded cursor-pointer border-2 border-gray-600">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-300 mb-1">Secondario</label>
                                    <input type="color" id="shirt-color-secondary" value="#ffffff" class="w-full h-10 rounded cursor-pointer border-2 border-gray-600">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-300 mb-1">Colletto</label>
                                    <input type="color" id="shirt-color-collar" value="#ffffff" class="w-full h-10 rounded cursor-pointer border-2 border-gray-600">
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="block text-sm text-gray-300 mb-1">Pattern</label>
                                <select id="shirt-pattern" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                                    <option value="solid">Tinta Unita</option>
                                    <option value="half-vertical">Meta Verticale</option>
                                    <option value="vertical-stripes">Strisce Verticali</option>
                                    <option value="horizontal-stripes">Strisce Orizzontali</option>
                                    <option value="diagonal-stripes">Strisce Diagonali</option>
                                    <option value="center-band-v">Banda Centrale Verticale</option>
                                    <option value="center-band-h">Banda Centrale Orizzontale</option>
                                    <option value="shoulders">Spalle Colorate</option>
                                    <option value="sleeves">Maniche Colorate</option>
                                    <option value="checkered">Scacchi</option>
                                </select>
                            </div>
                        </div>

                        <!-- PANTALONCINI -->
                        <div class="bg-gray-800 rounded-lg p-4 border-2 border-blue-600">
                            <h4 class="text-lg font-bold text-blue-400 mb-3">ü©≥ Pantaloncini</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm text-gray-300 mb-1">Primario</label>
                                    <input type="color" id="shorts-color-primary" value="#1a1a2e" class="w-full h-10 rounded cursor-pointer border-2 border-gray-600">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-300 mb-1">Secondario</label>
                                    <input type="color" id="shorts-color-secondary" value="#ffffff" class="w-full h-10 rounded cursor-pointer border-2 border-gray-600">
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="block text-sm text-gray-300 mb-1">Pattern</label>
                                <select id="shorts-pattern" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                                    <option value="solid">Tinta Unita</option>
                                    <option value="side-stripe">Strisce Laterali</option>
                                    <option value="half-vertical">Meta Verticale</option>
                                </select>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- PULSANTI AZIONI -->
                <div class="mt-6 flex gap-4">
                    <button id="btn-cancel-uniform"
                            class="flex-1 bg-gray-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-gray-500 transition duration-150">
                        Annulla
                    </button>
                    <button id="btn-save-uniform"
                            class="flex-1 bg-purple-600 text-white font-extrabold py-3 rounded-lg shadow-xl hover:bg-purple-500 transition duration-150">
                        Salva Divisa
                    </button>
                </div>
                <p id="uniform-editor-message" class="text-center mt-3"></p>
            </div>
        </div>

        <!-- MODAL CAMBIO PASSWORD -->
        <div id="change-password-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[9999] hidden flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-xl border-2 border-gray-500 shadow-2xl max-w-md w-full overflow-hidden">
                <div class="bg-gray-700 px-6 py-4 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <span>üîë</span> Cambia Password
                    </h3>
                    <button id="btn-close-change-password" class="text-white hover:text-gray-300 text-2xl font-bold">&times;</button>
                </div>
                <div class="p-6">
                    <div class="mb-4">
                        <label class="block text-gray-300 text-sm font-semibold mb-2">Nuova Password</label>
                        <input type="password" id="new-password-input"
                               class="w-full p-3 bg-gray-700 border-2 border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none"
                               placeholder="Inserisci la nuova password">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-300 text-sm font-semibold mb-2">Conferma Password</label>
                        <input type="password" id="confirm-password-input"
                               class="w-full p-3 bg-gray-700 border-2 border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none"
                               placeholder="Conferma la nuova password">
                    </div>
                    <p id="change-password-message" class="text-center mb-4 text-sm hidden"></p>
                    <div class="flex gap-3">
                        <button id="btn-cancel-change-password"
                                class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-semibold py-3 rounded-lg transition">
                            Annulla
                        </button>
                        <button id="btn-confirm-change-password"
                                class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3 rounded-lg transition">
                            Cambia Password
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL CHANGELOG -->
        <div id="changelog-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[9999] hidden flex items-center justify-center p-2 sm:p-4">
            <div class="bg-gray-800 rounded-xl border-2 border-indigo-500 shadow-2xl w-full max-w-[calc(100%-1rem)] sm:max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
                <div class="bg-indigo-600 px-6 py-4 flex justify-between items-center">
                    <h3 id="changelog-title" class="text-xl font-bold text-white flex items-center gap-2">
                        <span>üìã</span> Novita per i Giocatori
                    </h3>
                    <button onclick="window.Changelog?.hide()" class="text-white hover:text-gray-300 text-2xl font-bold">&times;</button>
                </div>
                <div id="changelog-content" class="p-6 overflow-y-auto flex-1">
                    <!-- Contenuto changelog inserito da JS -->
                </div>
                <div class="bg-gray-900 px-6 py-3 text-center">
                    <button onclick="window.Changelog?.hide()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-8 rounded-lg transition">
                        Chiudi
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- INIZIALIZZAZIONE FIREBASE e AUTH/DB -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // *** IMPORTAZIONE CRITICA: Importa TUTTE le funzioni necessarie per l'oggetto firestoreTools ***
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, where, getDocs, deleteDoc, updateDoc, deleteField, onSnapshot, orderBy, limit, Timestamp, runTransaction, writeBatch, enableIndexedDbPersistence, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Imposta il livello di log (solo errori per ridurre output console)
        setLogLevel('error');

        // Variabili globali fornite dall'ambiente Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Configurazione e inizializzazione standard (inclusa la tua config come fallback per i test locali)
        window.firebaseConfig = {
            apiKey: "AIzaSyDL0n4qFzpPd3v-aoJoI_GJCQ_hlpwbaSA",
            authDomain: "lega-fantacalcio-unica-2024.firebaseapp.com",
            projectId: "lega-fantacalcio-unica-2024",
            storageBucket: "lega-fantacalcio-unica-2024.firebasestorage.app",
            messagingSenderId: "219665032240",
            appId: "1:219665032240:web:14cfa85e5186384cc339f5",
            measurementId: "G-4WFPVEF886",
            // Unisce la configurazione fornita dal Canvas (se disponibile e valida)
            ...(firebaseConfig || {})
        };
        
        // Inizializzazione Firebase
        window.app = initializeApp(window.firebaseConfig);
        window.db = getFirestore(window.app);
        window.auth = getAuth(window.app);

        // Abilita cache offline per ridurre letture Firestore
        enableIndexedDbPersistence(window.db).then(() => {
            console.log("[Firebase] Offline persistence abilitata - cache locale attiva");
        }).catch((err) => {
            if (err.code === 'failed-precondition') {
                console.warn("[Firebase] Offline persistence non disponibile: app aperta in piu tab");
            } else if (err.code === 'unimplemented') {
                console.warn("[Firebase] Offline persistence non supportata da questo browser");
            }
        });

        // *** ESPOSIZIONE CRITICA (CORREZIONE) ***
        // Espone TUTTE le funzioni di Firestore a window.firestoreTools al momento dell'importazione.
        // Questo √® il punto chiave che garantisce la disponibilit√É∆í√Ü‚Äô√É‚Äö√Ç¬† di 'where'.
        window.firestoreTools = { doc, getDoc, setDoc, addDoc, collection, query, where, getDocs, deleteDoc, updateDoc, deleteField, onSnapshot, orderBy, limit, Timestamp, runTransaction, writeBatch, increment, appId }; 
        
        // Funzione globale per cambiare schermata
        window.showScreen = (elementToShow) => {
            const boxes = [
                document.getElementById('gate-box'),
                document.getElementById('login-box'),
                document.getElementById('app-content'),
                document.getElementById('admin-content'),
                document.getElementById('draft-content'),
                document.getElementById('leaderboard-content'),
                document.getElementById('schedule-content'),
                document.getElementById('championship-content'),
                document.getElementById('squadra-content'),
                document.getElementById('mercato-content'),
                document.getElementById('match-history-content'), // Hall of Fame
                document.getElementById('player-management-content'), // Gestione Giocatori Admin
                document.getElementById('team-management-content'), // Gestione Squadre Admin
                document.getElementById('feature-flags-content'), // Gestione Feature Flags Admin
                document.getElementById('coach-selection-box'), // Selezione Allenatore (NUOVO)
                document.getElementById('captain-selection-box'), // Selezione Capitano
                document.getElementById('user-championship-content'), // Campionato Utente (vecchio)
                document.getElementById('user-campionato-content'), // SerieSeriA Utente
                document.getElementById('user-coppa-content'), // CoppaSeriA Utente
                document.getElementById('user-supercoppa-content'), // Super CoppaSeriA Utente
                document.getElementById('stadium-content'), // Stadio
                document.getElementById('private-leagues-content') // Leghe Private
            ];
            boxes.forEach(box => {
                if (box) {
                    box.classList.add('hidden');
                    box.classList.add('hidden-on-load');
                }
            });
            if (elementToShow) {
                elementToShow.classList.remove('hidden');
                elementToShow.classList.remove('hidden-on-load');
            }
            // NOTA: La gestione della tab bar e' delegata a LayoutManager
            // che wrappa questa funzione e applica il layout appropriato
        };


        // Funzione per l'autenticazione iniziale (necessaria per accedere a Firestore)
        async function initialAuth() {
            try {
                // Tenta di autenticare con il token fornito dall'ambiente (se presente)
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                    console.log("Autenticazione Firebase riuscita con token personalizzato.");
                } else {
                    // Altrimenti, usa l'accesso anonimo come fallback
                    await signInAnonymously(window.auth);
                    console.log("Autenticazione Firebase riuscita in modalit√É∆í√Ü‚Äô√É‚Äö√Ç¬† anonima.");
                }
            } catch (error) {
                console.error("Errore durante l'autenticazione iniziale:", error);
                // In caso di errore critico, si pu√É∆í√Ü‚Äô√É‚Äö√Ç¬≤ mostrare un messaggio di fallback all'utente
            }
        }
        
        initialAuth();

        // FALLBACK DI SICUREZZA: Se dopo 5 secondi nessuna schermata e' visibile, mostra la homepage
        setTimeout(() => {
            const loginBox = document.getElementById('login-box');
            const appContent = document.getElementById('app-content');
            const adminContent = document.getElementById('admin-content');

            // Controlla se almeno una schermata principale e' visibile
            const isAnyVisible =
                (loginBox && !loginBox.classList.contains('hidden') && !loginBox.classList.contains('hidden-on-load')) ||
                (appContent && !appContent.classList.contains('hidden') && !appContent.classList.contains('hidden-on-load')) ||
                (adminContent && !adminContent.classList.contains('hidden') && !adminContent.classList.contains('hidden-on-load'));

            if (!isAnyVisible && loginBox) {
                console.warn('[Fallback] Nessuna schermata visibile dopo 5s, mostro homepage');
                loginBox.classList.remove('hidden-on-load', 'hidden');
            }
        }, 5000);

    </script>
    
    <!-- Collega gli script JavaScript esterni - DEVE ESSERE DOPO GLI SCRIPT FIREBASE -->
    
    <!-- 1. DEFINIZIONI BASE (Icone, Costanti, Variabili Globali) -->
    <script src="icone.js?v=3"></script>
    <script src="logger.js"></script>
    <script src="firestore-cache.js"></script>
    <script src="config-listener.js"></script>
    <script src="leaderboard-listener.js"></script>
    <script src="schedule-listener.js"></script>
    <script src="teams-listener.js"></script>
    <script src="listener-manager.js"></script>
    <script src="interfaccia-core.js"></script>
    <script src="responsive-images.js"></script>

    <!-- 1.5 UTILITY UI (Toast, Dialogs, Loading, Validazione) -->
    <script src="toast.js"></script>
    <script src="confirm-dialog.js"></script>
    <script src="skeleton-loader.js"></script>
    <script src="loading-manager.js"></script>
    <script src="error-handler.js"></script>
    <script src="form-validator.js"></script>
    <script src="breadcrumb.js"></script>

    <!-- 1.6 FEATURE FLAGS SYSTEM (Sistema toggle funzionalita') -->
    <script src="feature-flags.js"></script>

    <!-- 1.7 MODULI FEATURE OPZIONALI (Controllati da Feature Flags) -->
    <script src="notifications.js"></script>
    <script src="proactive-notifications.js"></script>
    <script src="player-stats-advanced.js"></script>
    <script src="chat.js"></script>
    <script src="trades.js"></script>
    <script src="achievements.js"></script>
    <script src="injuries.js"></script>
    <script src="stadium.js"></script>
    <script src="stadium-ui.js"></script>
    <script src="club-history.js"></script>
    <script src="training.js"></script>
    <script src="match-animations.js"></script>
    <script src="drag-drop.js"></script>
    <script src="challenges.js"></script>
    <script src="challenge-match.js"></script>
    <script src="challenge-minigame.js"></script>
    <script src="sfide-minigame.js"></script>
    <script src="dashboard-features.js"></script>
    <script src="layout-manager.js"></script>
    <script src="dashboard-tabs.js"></script>
    <script src="next-match-alert.js"></script>
    <script src="tutorial.js"></script>
    <script src="changelog.js"></script>
    <script src="match-history.js"></script>
    <script src="match-credits.js"></script>
    <script src="sponsor-system.js"></script>
    <script src="private-leagues.js"></script>
    <script src="private-leagues-ui.js"></script>
    <script src="contracts.js"></script>
    <script src="image-compressor.js"></script>
    <script src="lazy-loader.js"></script>
    <script src="tests.js"></script>

    <!-- 2. LOGICA DI SIMULAZIONE (Dipende solo dalle costanti) -->
    <script src="game-constants.js"></script>
    <script src="abilita-effects.js"></script>
    <script src="simulazione.js"></script>
    <script src="simulazione-nuove-regole.js"></script>
    <script src="simulation-highlights.js"></script>

    <!-- 3. MODULI CORE INTERFACCIA (Dipendono da Core) -->
    <script src="interfaccia-auth.js"></script>       
    <script src="interfaccia-dashboard.js"></script>
    <script src="interfaccia-navigation.js"></script>
    <script src="interfaccia-onboarding.js"></script>
    <script src="interfaccia-team.js"></script>

    <!-- UNIFORM EDITOR (serve a gestionesquadre-formazione) -->
    <script src="uniform-editor.js"></script>

    <!-- MODULI GESTIONE SQUADRE (in ordine di dipendenza) -->
    <script src="gestionesquadre-constants.js"></script>
    <script src="gestionesquadre-utils.js"></script>
    <script src="gestionesquadre-rosa.js"></script>
    <script src="gestionesquadre-formazione.js"></script>
    <script src="gestionesquadre-icona.js"></script>
    <script src="gestionesquadre.js"></script> <!-- Orchestratore -->
    
    <!-- 4. LOGICHE DI ACQUISTO (Dipendono da Core e possibilmente da Auth/Team) -->
    <!-- MODULI DRAFT (in ordine di dipendenza) -->
    <script src="draft-constants.js"></script>
    <script src="draft-timer-sync.js"></script>
    <script src="draft-utils.js"></script>
    <script src="draft-turns.js"></script>
    <script src="draft-admin-ui.js"></script>
    <script src="draft-admin-players.js"></script>
    <script src="draft-user-ui.js"></script>
    <script src="draft-user-actions.js"></script>
    <script src="draft-status-box.js"></script>
    <script src="draft.js"></script> <!-- Orchestratore Draft -->
    <script src="mercato.js"></script> 

    <!-- 5. LOGICHE ADMIN (Dipendono da Core, Admin-UI/Players/Teams) -->
    <script src="admin-formulas.js"></script>
    <script src="admin-rewards.js"></script>
    <script src="admin-sponsors.js"></script>
    <script src="admin-media.js"></script>
    <script src="admin-figurine.js"></script>
    <script src="admin-wheel.js"></script>
    <script src="admin-schedina.js"></script>
    <script src="admin-ui.js"></script>
    <script src="admin-players.js"></script>
    <script src="admin-teams.js"></script>
    <script src="admin-icons.js"></script>
    <script src="admin.js"></script>
    <script src="admin-feature-flags.js"></script>
    <script src="admin-objects.js"></script>
    <script src="admin-data-sync.js"></script>
    <script src="equipment-ui.js"></script>

    <!-- 6. LOGICHE CAMPIONATO (Dipendono da Simulation, Core e Admin) -->
    <script src="player-season-stats.js"></script>
    <script src="player-season-stats-ui.js"></script>
    <script src="player-exp.js"></script>
    <script src="player-exp-ui.js"></script>
    <script src="training-exp-minigame.js"></script>
    <script src="campionato-rewards.js"></script>
    <script src="campionato-simulation.js"></script>
    <script src="campionato-schedule.js"></script>
    <script src="campionato-ui.js"></script>
    <script src="campionato-main.js"></script>
    <script src="campionato.js"></script>

    <!-- Schedina Pronostici -->
    <script src="schedina.js"></script>
    <script src="schedina-ui.js"></script>

    <script src="automazione-simulazioni.js"></script>

    <!-- 7. COPPASERIA (Dipendono da Campionato e Simulation) -->
    <script src="coppa-constants.js"></script>
    <script src="coppa-brackets.js"></script>
    <script src="coppa-simulation.js"></script>
    <script src="coppa-schedule.js"></script>
    <script src="coppa-ui.js"></script>
    <script src="coppa-main.js"></script>

    <!-- 8. SUPERCOPPA (Dipende da Campionato e Coppa) -->
    <script src="supercoppa.js"></script>

    <!-- 9. ORCHESTRATORE FINALE (Avvia l'app) -->
    <script src="interfaccia.js"></script>

    <!-- 10. MATCH REPLAY SYSTEM -->
    <script src="match-replay-simple.js"></script>

    <!-- 11. PLAYER STATS SYSTEM -->
    <script src="player-stats.js"></script>
    <script src="player-stats-ui.js"></script>

    <!-- 12. ABILITIES ENCYCLOPEDIA -->
    <script src="abilities-encyclopedia.js"></script>
    <script src="abilities-encyclopedia-ui.js"></script>
    <script src="rules-panel.js"></script>
    <script src="sponsor-media.js"></script>
    <script src="user-championship.js"></script>
    <script src="user-competitions.js"></script>

    <!-- 13. CREDITI SUPER SERI (Valuta Premium) -->
    <script src="crediti-super-seri.js"></script>
    <script src="crediti-super-seri-ui.js"></script>

    <!-- 13b. RUOTA DELLA FORTUNA GIORNALIERA -->
    <script src="daily-wheel.js"></script>
    <script src="daily-wheel-ui.js"></script>

    <!-- 13c. ALBUM FIGURINE -->
    <script src="figurine.js"></script>
    <script src="figurine-ui.js"></script>

    <!-- 16. PWA SERVICE WORKER REGISTRATION E GESTIONE AGGIORNAMENTI -->
    <script src="pwa-install.js"></script>

    <!-- MATCH REPLAY OVERLAY (spostato qui da dopo </html>) -->
    <div id="match-replay-overlay" class="fixed inset-0 bg-black bg-opacity-95 z-50 hidden overflow-y-auto">
        <div class="container mx-auto px-4 py-8 max-w-4xl">

            <!-- Header con controlli -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">üé¨ Replay Partita</h2>

                <div class="flex gap-3">
                    <!-- Velocita -->
                    <button id="replay-speed-btn"
                            onclick="window.MatchReplaySimple?.changeSpeed()"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Velocita: 1x
                    </button>

                    <!-- Chiudi (solo se non in riproduzione) -->
                    <button id="replay-skip-btn"
                            onclick="window.MatchReplaySimple?.hide()"
                            class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                        Salta ‚è≠Ô∏è
                    </button>
                </div>
            </div>

            <!-- Contenuto dinamico replay -->
            <div id="replay-content" class="min-h-[500px] flex items-center justify-center">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-500 mx-auto mb-4"></div>
                    <p class="text-white text-lg">Caricamento replay...</p>
                </div>
            </div>

        </div>
    </div>

    <!-- ========== GLOBAL TAB BAR (BOTTOM NAVIGATION - FIXED) ========== -->
    <div id="dashboard-tabs" class="hidden fixed bottom-0 left-0 right-0 z-50 flex bg-gray-900/70 border-t border-gray-700 shadow-lg">
        <button id="dashboard-tab-login" class="dashboard-tab flex-1 py-2 sm:py-3 text-center font-bold text-[9px] sm:text-[10px] bg-gray-900 text-gray-400 border-t-2 border-transparent transition hover:bg-gray-800 hover:text-white flex flex-col items-center gap-0.5" data-tab="login">
            <span class="text-base sm:text-lg">üè°</span>
            <span>Home</span>
        </button>
        <button id="dashboard-tab-dashboard" class="dashboard-tab auth-required hidden flex-1 py-2 sm:py-3 text-center font-bold text-[9px] sm:text-[10px] bg-green-600 text-white border-t-2 border-green-400 transition hover:bg-green-500 flex flex-col items-center gap-0.5" data-tab="home">
            <span class="text-base sm:text-lg">üìä</span>
            <span>Board</span>
        </button>
        <button id="dashboard-tab-squad" class="dashboard-tab auth-required hidden flex-1 py-2 sm:py-3 text-center font-bold text-[9px] sm:text-[10px] bg-gray-900 text-gray-400 border-t-2 border-transparent transition hover:bg-gray-800 hover:text-white flex flex-col items-center gap-0.5" data-tab="squad">
            <span class="text-base sm:text-lg">üë•</span>
            <span>Squadra</span>
        </button>
        <button id="dashboard-tab-competitions" class="dashboard-tab auth-required hidden flex-1 py-2 sm:py-3 text-center font-bold text-[9px] sm:text-[10px] bg-gray-900 text-gray-400 border-t-2 border-transparent transition hover:bg-gray-800 hover:text-white flex flex-col items-center gap-0.5" data-tab="competitions">
            <span class="text-base sm:text-lg">üèÜ</span>
            <span>Gare</span>
        </button>
        <button id="dashboard-tab-shop" class="dashboard-tab auth-required hidden flex-1 py-2 sm:py-3 text-center font-bold text-[9px] sm:text-[10px] bg-gray-900 text-gray-400 border-t-2 border-transparent transition hover:bg-gray-800 hover:text-white flex flex-col items-center gap-0.5" data-tab="shop">
            <span class="text-base sm:text-lg">üõí</span>
            <span>Shop</span>
        </button>
        <button id="dashboard-tab-rules" class="dashboard-tab flex-1 py-2 sm:py-3 text-center font-bold text-[9px] sm:text-[10px] bg-gray-900 text-gray-400 border-t-2 border-transparent transition hover:bg-gray-800 hover:text-white flex flex-col items-center gap-0.5" data-tab="rules">
            <span class="text-base sm:text-lg">üìñ</span>
            <span>Regole</span>
        </button>
        <button id="dashboard-tab-admin" class="dashboard-tab auth-required hidden flex-1 py-2 sm:py-3 text-center font-bold text-[9px] sm:text-[10px] bg-gray-900 text-gray-400 border-t-2 border-transparent transition hover:bg-gray-800 hover:text-white flex flex-col items-center gap-0.5" data-tab="admin">
            <span class="text-base sm:text-lg">üîß</span>
            <span>Admin</span>
        </button>
    </div>

</body>
</html>

<!-- NOTA: Il vecchio codice PWA inline e le animazioni CSS sono stati estratti in:
     - pwa-install.js (logica PWA)
     - style.css (animazioni replay)
     Il contenuto che era dopo </html> e' stato rimosso (era HTML invalido).
-->
